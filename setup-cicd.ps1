# Script de Configura√ß√£o Autom√°tica do ArcSat CI/CD
# Execute com: .\setup-cicd.ps1

Write-Host "üöÄ ArcSat - Configura√ß√£o de CI/CD" -ForegroundColor Cyan
Write-Host "=================================" -ForegroundColor Cyan
Write-Host ""

# 1. Verificar Azure CLI
Write-Host "‚úÖ Verificando Azure CLI..." -ForegroundColor Yellow
$azVersion = az version 2>$null
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Azure CLI n√£o encontrado. Instale em: https://aka.ms/installazurecli" -ForegroundColor Red
    exit 1
}
Write-Host "   Azure CLI detectado" -ForegroundColor Green

# 2. Obter token do Azure Static Web App
Write-Host ""
Write-Host "‚úÖ Obtendo token do Azure Static Web App..." -ForegroundColor Yellow
$azureToken = az staticwebapp secrets list `
    --name arcsat-frontend `
    --resource-group Avila `
    --query "properties.apiKey" `
    --output tsv 2>$null

if ([string]::IsNullOrEmpty($azureToken)) {
    Write-Host "‚ùå Erro ao obter token do Azure" -ForegroundColor Red
    exit 1
}
Write-Host "   Token obtido (comprimento: $($azureToken.Length))" -ForegroundColor Green

# 3. Verificar GitHub CLI
Write-Host ""
Write-Host "‚úÖ Verificando GitHub CLI..." -ForegroundColor Yellow
$ghVersion = gh --version 2>$null
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ö†Ô∏è  GitHub CLI n√£o encontrado" -ForegroundColor Yellow
    Write-Host "   Salvando token em arquivo..." -ForegroundColor Yellow
    $azureToken | Out-File -FilePath ".\AZURE_TOKEN.txt" -Encoding UTF8 -NoNewline
    Write-Host ""
    Write-Host "üìã Configure manualmente:" -ForegroundColor Cyan
    Write-Host "   1. Acesse: https://github.com/avilaops/ArcSat/settings/secrets/actions"
    Write-Host "   2. Crie secret: AZURE_STATIC_WEB_APPS_API_TOKEN"
    Write-Host "   3. Cole o conte√∫do de: AZURE_TOKEN.txt"
    Write-Host "   4. Delete o arquivo: Remove-Item .\AZURE_TOKEN.txt"
    exit 0
}

# 4. Verificar autentica√ß√£o do GitHub
Write-Host "   GitHub CLI detectado" -ForegroundColor Green
Write-Host ""
Write-Host "‚úÖ Verificando autentica√ß√£o do GitHub..." -ForegroundColor Yellow
gh auth status 2>&1 | Out-Null
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå N√£o autenticado no GitHub" -ForegroundColor Red
    Write-Host "   Execute: gh auth login" -ForegroundColor Yellow
    exit 1
}
Write-Host "   Autenticado" -ForegroundColor Green

# 5. Configurar secret no GitHub
Write-Host ""
Write-Host "‚úÖ Configurando secret AZURE_STATIC_WEB_APPS_API_TOKEN..." -ForegroundColor Yellow
$azureToken | gh secret set AZURE_STATIC_WEB_APPS_API_TOKEN `
    --repo avilaops/ArcSat `
    2>$null

if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Erro ao configurar secret" -ForegroundColor Red
    exit 1
}
Write-Host "   Secret configurado com sucesso!" -ForegroundColor Green

# 6. Listar secrets configurados
Write-Host ""
Write-Host "‚úÖ Secrets configurados no reposit√≥rio:" -ForegroundColor Yellow
gh secret list --repo avilaops/ArcSat 2>$null

# 7. Verificar √∫ltimo workflow
Write-Host ""
Write-Host "‚úÖ Verificando √∫ltimo workflow..." -ForegroundColor Yellow
$lastRun = gh run list --repo avilaops/ArcSat --limit 1 --json status,conclusion,createdAt,name 2>$null | ConvertFrom-Json
if ($lastRun) {
    Write-Host "   Nome: $($lastRun[0].name)" -ForegroundColor White
    Write-Host "   Status: $($lastRun[0].status)" -ForegroundColor White
    Write-Host "   Conclus√£o: $($lastRun[0].conclusion)" -ForegroundColor White
    Write-Host "   Criado em: $($lastRun[0].createdAt)" -ForegroundColor White
}

# 8. Pr√≥ximos passos
Write-Host ""
Write-Host "üéâ Configura√ß√£o conclu√≠da!" -ForegroundColor Green
Write-Host ""
Write-Host "üìã Pr√≥ximos passos:" -ForegroundColor Cyan
Write-Host "   1. Fa√ßa um commit e push para testar o workflow"
Write-Host "   2. Monitore em: https://github.com/avilaops/ArcSat/actions"
Write-Host "   3. Configure environments (opcional):"
Write-Host "      https://github.com/avilaops/ArcSat/settings/environments"
Write-Host ""
Write-Host "üåê Seu site:" -ForegroundColor Cyan
Write-Host "   ‚Ä¢ Azure: https://wonderful-sand-0adc5890f.3.azurestaticapps.net"
Write-Host "   ‚Ä¢ Custom: https://www.arcsat.com.br"
Write-Host ""
