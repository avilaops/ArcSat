// ArcSat Industrial - Gest√£o de Clientes para Consultoria
// M√≥dulo integrado com MongoDB Atlas e Azure AI

const { OpenAIClient, AzureKeyCredential } = require('@azure/openai');
const { DefaultAzureCredential } = require('@azure/identity');
const mongoose = require('mongoose');
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
require('dotenv').config();

// Schema do Cliente Industrial
const ClienteIndustrialSchema = new mongoose.Schema({
    nomeEmpresa: { type: String, required: true },
    cnpj: { type: String, unique: true },
    setor: { type: String, required: true },
    numeroFuncionarios: { type: Number, required: true },
    endereco: {
        cep: String,
        cidade: String,
        estado: String,
        endereco: String
    },
    contato: {
        responsavel: String,
        telefone: String,
        email: String
    },
    desafios: [String],
    especializacao: {
        type: String,
        enum: ['lean_manufacturing', 'iso_compliance', 'industry_40', 'safety_management'],
        default: 'lean_manufacturing'
    },
    etapaConsultoria: {
        type: String,
        enum: ['diagnostico_inicial', 'proposta_comercial', 'implementacao', 'monitoramento', 'finalizado'],
        default: 'diagnostico_inicial'
    },
    status: {
        type: String,
        enum: ['ativo', 'inativo', 'lead', 'cliente', 'ex_cliente'],
        default: 'lead'
    },
    kpis: {
        oee_atual: Number,
        oee_target: Number,
        defeitos_percentual: Number,
        produtividade_baseline: Number,
        custos_manutencao: Number,
        tempo_setup: Number,
        disponibilidade: Number
    },
    analise_ia: {
        especializacao_recomendada: String,
        prioridades: [String],
        roi_estimado: String,
        timeline_meses: Number,
        modulos: [String],
        confidence_score: Number
    },
    historico: [{
        timestamp: { type: Date, default: Date.now },
        acao: String,
        tipo: String,
        usuario: String,
        detalhes: mongoose.Schema.Types.Mixed
    }],
    documentos: [{
        nome: String,
        tipo: String,
        url: String,
        dataUpload: { type: Date, default: Date.now }
    }],
    dataCreated: { type: Date, default: Date.now },
    dataUpdated: { type: Date, default: Date.now }
}, {
    timestamps: true
});

// √çndices para performance
ClienteIndustrialSchema.index({ nomeEmpresa: 'text', setor: 'text' });
ClienteIndustrialSchema.index({ setor: 1, status: 1 });
ClienteIndustrialSchema.index({ etapaConsultoria: 1 });

const ClienteIndustrial = mongoose.model('ClienteIndustrial', ClienteIndustrialSchema);

class GestaoClientesIndustrial {
    constructor() {
        this.app = express();
        this.port = process.env.PORT || 5000;
        this.setupMiddleware();
        this.connectMongoDB();
        this.setupAzureAI();
        this.setupRoutes();
    }

    setupMiddleware() {
        this.app.use(helmet());
        this.app.use(cors());
        this.app.use(express.json());
        this.app.use(express.static('public'));
    }

    async connectMongoDB() {
        try {
            const mongoUri = process.env.MONGODB_URI || process.env.MONGO_URI || 'mongodb://localhost:27017/arcsat-industrial';
            
            await mongoose.connect(mongoUri, {
                maxPoolSize: 10,
                minPoolSize: 2,
                maxIdleTimeMS: 30000,
                serverSelectionTimeoutMS: 5000,
                socketTimeoutMS: 45000,
            });
            
            console.log('‚úÖ MongoDB Atlas conectado com sucesso');
            console.log(`üìä Database: ${mongoose.connection.name}`);
            
            // Event listeners para monitoramento
            mongoose.connection.on('error', (error) => {
                console.error('‚ùå Erro MongoDB:', error);
            });

            mongoose.connection.on('disconnected', () => {
                console.warn('‚ö†Ô∏è  MongoDB desconectado');
            });

            mongoose.connection.on('reconnected', () => {
                console.log('üîÑ MongoDB reconectado');
            });

        } catch (error) {
            console.error('‚ùå Erro ao conectar MongoDB Atlas:', error.message);
            console.log('üîÑ Tentando novamente em 5 segundos...');
            setTimeout(() => this.connectMongoDB(), 5000);
        }
    }

    setupAzureAI() {
        try {
            // Configurar Azure OpenAI
            const endpoint = process.env.AZURE_OPENAI_ENDPOINT || 'https://arcsat-resource.openai.azure.com/';
            const apiKey = process.env.AZURE_OPENAI_API_KEY;
            
            if (apiKey) {
                this.openaiClient = new OpenAIClient(endpoint, new AzureKeyCredential(apiKey));
                console.log('‚úÖ Azure OpenAI configurado com sucesso');
            } else {
                console.log('‚ö†Ô∏è  Azure OpenAI API Key n√£o encontrada, usando modo offline');
            }
        } catch (error) {
            console.log('‚ö†Ô∏è  Erro ao configurar Azure AI:', error.message);
        }
    }

    setupRoutes() {
        // Health check
        this.app.get('/health', async (req, res) => {
            const dbStatus = mongoose.connection.readyState === 1 ? 'connected' : 'disconnected';
            const clientesCount = await ClienteIndustrial.countDocuments();
            
            res.json({ 
                status: 'ok', 
                timestamp: new Date().toISOString(),
                azure_ai: !!this.openaiClient,
                mongodb: dbStatus,
                clientes_total: clientesCount,
                version: '1.0.0'
            });
        });

        // Gest√£o de Clientes Industriais
        this.app.post('/api/clientes/novo', async (req, res) => {
            try {
                const cliente = await this.criarNovoCliente(req.body);
                res.json({ success: true, cliente });
            } catch (error) {
                console.error('Erro ao criar cliente:', error);
                res.status(500).json({ error: error.message });
            }
        });

        this.app.get('/api/clientes/:id/diagnostico', async (req, res) => {
            try {
                const diagnostico = await this.gerarDiagnosticoIA(req.params.id);
                res.json({ success: true, diagnostico });
            } catch (error) {
                res.status(500).json({ error: error.message });
            }
        });

        this.app.get('/api/clientes/:id/relatorio', async (req, res) => {
            try {
                const relatorio = await this.gerarRelatorioExecutivo(req.params.id);
                res.json({ success: true, relatorio });
            } catch (error) {
                res.status(500).json({ error: error.message });
            }
        });

        this.app.get('/api/clientes', async (req, res) => {
            try {
                const { setor, status, etapa, limit = 20, skip = 0 } = req.query;
                
                // Filtros din√¢micos
                const filtros = {};
                if (setor) filtros.setor = setor;
                if (status) filtros.status = status;
                if (etapa) filtros.etapaConsultoria = etapa;

                const clientes = await ClienteIndustrial
                    .find(filtros)
                    .select('-historico -documentos') // Campos pesados opcionais
                    .limit(parseInt(limit))
                    .skip(parseInt(skip))
                    .sort({ dataCreated: -1 });

                const total = await ClienteIndustrial.countDocuments(filtros);

                res.json({ 
                    success: true, 
                    clientes,
                    pagination: {
                        total,
                        limit: parseInt(limit),
                        skip: parseInt(skip),
                        hasMore: (parseInt(skip) + parseInt(limit)) < total
                    }
                });
            } catch (error) {
                res.status(500).json({ error: error.message });
            }
        });

        // Busca textual
        this.app.get('/api/clientes/buscar/:termo', async (req, res) => {
            try {
                const termo = req.params.termo;
                const clientes = await ClienteIndustrial
                    .find({ $text: { $search: termo } })
                    .select('-historico -documentos')
                    .limit(10);

                res.json({ success: true, clientes });
            } catch (error) {
                res.status(500).json({ error: error.message });
            }
        });

        // Atualizar cliente
        this.app.put('/api/clientes/:id', async (req, res) => {
            try {
                const cliente = await ClienteIndustrial.findByIdAndUpdate(
                    req.params.id,
                    { ...req.body, dataUpdated: new Date() },
                    { new: true, runValidators: true }
                );

                if (!cliente) {
                    return res.status(404).json({ error: 'Cliente n√£o encontrado' });
                }

                // Adicionar ao hist√≥rico
                await this.adicionarHistorico(req.params.id, 'Dados atualizados', 'update', req.body);

                res.json({ success: true, cliente });
            } catch (error) {
                res.status(500).json({ error: error.message });
            }
        });

        // Estat√≠sticas do dashboard
        this.app.get('/api/dashboard/stats', async (req, res) => {
            try {
                const stats = await this.gerarEstatisticasDashboard();
                res.json({ success: true, stats });
            } catch (error) {
                res.status(500).json({ error: error.message });
            }
        });

        // Dashboard para consultoria
        this.app.get('/dashboard', (req, res) => {
            res.send(this.getDashboardHTML());
        });
    }

    async criarNovoCliente(dadosCliente) {
        try {
            // Criar novo cliente no MongoDB
            const cliente = new ClienteIndustrial({
                ...dadosCliente,
                dataCreated: new Date(),
                status: 'lead',
                etapaConsultoria: 'diagnostico_inicial'
            });

            // An√°lise inicial com IA (se dispon√≠vel)
            if (this.openaiClient) {
                try {
                    const analiseIA = await this.analisarPerfilCliente(cliente);
                    cliente.analise_ia = analiseIA;
                } catch (error) {
                    console.log('IA offline, continuando sem an√°lise autom√°tica');
                    cliente.analise_ia = {
                        especializacao_recomendada: 'lean_manufacturing',
                        prioridades: ['eficiencia_operacional'],
                        roi_estimado: '250-400%',
                        timeline_meses: 6,
                        modulos: ['diagnostico_inicial'],
                        confidence_score: 0.5
                    };
                }
            }

            // Salvar no MongoDB
            const clienteSalvo = await cliente.save();
            
            // Adicionar registro no hist√≥rico
            await this.adicionarHistorico(clienteSalvo._id, 'Cliente criado no sistema', 'criacao');
            
            return clienteSalvo;
        } catch (error) {
            console.error('Erro ao criar cliente:', error);
            throw new Error(`Erro ao salvar cliente: ${error.message}`);
        }
    }

    async analisarPerfilCliente(cliente) {
        if (!this.openaiClient) {
            return { status: 'offline', message: 'IA n√£o dispon√≠vel' };
        }

        const prompt = `
        Analise o perfil desta ind√∫stria para consultoria:
        
        Empresa: ${cliente.nomeEmpresa}
        Setor: ${cliente.setor}
        Funcion√°rios: ${cliente.numeroFuncionarios}
        Principais Desafios: ${cliente.desafios || 'N√£o especificado'}
        
        Forne√ßa:
        1. Especializa√ß√£o recomendada (Lean, ISO, Ind√∫stria 4.0, Seguran√ßa)
        2. Prioridades de consultoria
        3. ROI estimado
        4. Timeline sugerida
        5. M√≥dulos recomendados
        
        Responda em formato JSON estruturado.
        `;

        try {
            const response = await this.openaiClient.getChatCompletions(
                'gpt-4o-mini', // ou o modelo que voc√™ tem dispon√≠vel
                [{ role: 'user', content: prompt }],
                { maxTokens: 800, temperature: 0.7 }
            );

            return JSON.parse(response.choices[0].message.content);
        } catch (error) {
            return { 
                especializacao_recomendada: 'lean_manufacturing',
                prioridades: ['reducao_desperdicios', 'aumento_produtividade'],
                roi_estimado: '250-400%',
                timeline_meses: 6,
                modulos: ['diagnostico_lean', 'kanban_digital', 'oee_dashboard']
            };
        }
    }

    async gerarDiagnosticoIA(clienteId) {
        const cliente = this.clientes.get(clienteId);
        if (!cliente) throw new Error('Cliente n√£o encontrado');

        const diagnostico = {
            cliente_id: clienteId,
            data_diagnostico: new Date().toISOString(),
            situacao_atual: {},
            oportunidades: [],
            recomendacoes: [],
            roi_projetado: null
        };

        if (this.openaiClient) {
            try {
                const prompt = `
                Gere um diagn√≥stico industrial detalhado para:
                
                Empresa: ${cliente.nomeEmpresa}
                Setor: ${cliente.setor}
                Funcion√°rios: ${cliente.numeroFuncionarios}
                Desafios: ${cliente.desafios}
                
                Inclua:
                1. An√°lise da situa√ß√£o atual
                2. Principais oportunidades de melhoria
                3. Recomenda√ß√µes espec√≠ficas
                4. ROI projetado
                5. Pr√≥ximos passos priorit√°rios
                
                Formato JSON estruturado.
                `;

                const response = await this.openaiClient.getChatCompletions(
                    'gpt-4o-mini',
                    [{ role: 'user', content: prompt }],
                    { maxTokens: 1200, temperature: 0.6 }
                );

                Object.assign(diagnostico, JSON.parse(response.choices[0].message.content));
            } catch (error) {
                console.log('Usando diagn√≥stico template offline');
            }
        }

        // Fallback se IA n√£o dispon√≠vel
        if (!diagnostico.situacao_atual.resumo) {
            diagnostico.situacao_atual = {
                resumo: `An√°lise inicial para ${cliente.nomeEmpresa}`,
                areas_criticas: ['Efici√™ncia operacional', 'Controle de qualidade', 'Gest√£o de estoque'],
                indicadores_atuais: 'Em avalia√ß√£o'
            };
            diagnostico.oportunidades = [
                'Implementa√ß√£o de metodologia Lean',
                'Automa√ß√£o de processos cr√≠ticos',
                'Sistema de gest√£o visual',
                'Controle estat√≠stico de qualidade'
            ];
            diagnostico.roi_projetado = '250-400% em 8-12 meses';
        }

        this.adicionarHistorico(clienteId, 'Diagn√≥stico gerado', 'diagnostico');
        return diagnostico;
    }

    async gerarRelatorioExecutivo(clienteId) {
        const cliente = this.clientes.get(clienteId);
        if (!cliente) throw new Error('Cliente n√£o encontrado');

        const relatorio = {
            cliente: cliente.nomeEmpresa,
            data: new Date().toLocaleDateString('pt-BR'),
            resumo_executivo: {},
            kpis_principais: {},
            recomendacoes: [],
            proximos_passos: []
        };

        if (this.openaiClient) {
            try {
                const prompt = `
                Gere um relat√≥rio executivo de consultoria industrial para:
                
                Cliente: ${cliente.nomeEmpresa}
                Setor: ${cliente.setor}
                Etapa: ${cliente.etapaConsultoria}
                
                Inclua:
                1. Resumo executivo
                2. KPIs principais
                3. Recomenda√ß√µes estrat√©gicas
                4. Pr√≥ximos passos
                5. Timeline de implementa√ß√£o
                
                Formato executivo profissional em JSON.
                `;

                const response = await this.openaiClient.getChatCompletions(
                    'gpt-4o-mini',
                    [{ role: 'user', content: prompt }],
                    { maxTokens: 1000, temperature: 0.5 }
                );

                Object.assign(relatorio, JSON.parse(response.choices[0].message.content));
            } catch (error) {
                console.log('Usando relat√≥rio template offline');
            }
        }

        // Template offline
        if (!relatorio.resumo_executivo.situacao) {
            relatorio.resumo_executivo = {
                situacao: `Consultoria em andamento para ${cliente.nomeEmpresa}`,
                progresso: 'Fase de diagn√≥stico conclu√≠da',
                resultado_esperado: 'Aumento de 30-50% na efici√™ncia operacional'
            };
            relatorio.kpis_principais = {
                eficiencia: 'Em avalia√ß√£o',
                qualidade: 'Baseline sendo estabelecido',
                produtividade: 'Potencial de melhoria identificado'
            };
            relatorio.proximos_passos = [
                'Implementa√ß√£o de sistema Kanban',
                'Treinamento de equipe em Lean',
                'Setup de dashboards de monitoramento',
                'In√≠cio da fase de implementa√ß√£o'
            ];
        }

        this.adicionarHistorico(clienteId, 'Relat√≥rio executivo gerado', 'relatorio');
        return relatorio;
    }

    adicionarHistorico(clienteId, acao, tipo) {
        const cliente = this.clientes.get(clienteId);
        if (cliente) {
            cliente.historico.push({
                timestamp: new Date().toISOString(),
                acao,
                tipo,
                usuario: 'sistema'
            });
        }
    }

    getDashboardHTML() {
        return `
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ArcSat Industrial - Gest√£o de Clientes</title>
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f5f7fa; }
                .header { background: linear-gradient(135deg, #0077FF, #00E0FF); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
                .container { max-width: 1200px; margin: 0 auto; }
                .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
                .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                .btn { background: #0077FF; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; margin: 5px; }
                .btn:hover { background: #0056CC; }
                .status { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
                .status.ativo { background: #e8f5e8; color: #2d5a2d; }
                .footer { text-align: center; margin-top: 40px; color: #666; }
                #clientes { margin-top: 20px; }
                .cliente-item { background: white; margin: 10px 0; padding: 15px; border-radius: 8px; border-left: 4px solid #0077FF; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>üè≠ ArcSat Industrial - Gest√£o de Clientes</h1>
                    <p>Sistema inteligente para consultoria industrial com IA</p>
                </div>
                
                <div class="cards">
                    <div class="card">
                        <h3>üìä Novo Cliente</h3>
                        <p>Cadastrar nova ind√∫stria para consultoria</p>
                        <button class="btn" onclick="novoCliente()">+ Adicionar Cliente</button>
                    </div>
                    
                    <div class="card">
                        <h3>üîç Diagn√≥stico IA</h3>
                        <p>Gerar an√°lise autom√°tica com intelig√™ncia artificial</p>
                        <button class="btn" onclick="gerarDiagnostico()">ü§ñ Diagn√≥stico IA</button>
                    </div>
                    
                    <div class="card">
                        <h3>üìã Relat√≥rio Executivo</h3>
                        <p>Relat√≥rio profissional para apresenta√ß√£o</p>
                        <button class="btn" onclick="gerarRelatorio()">üìä Gerar Relat√≥rio</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üë• Clientes Ativos</h3>
                    <div id="clientes">Carregando clientes...</div>
                    <button class="btn" onclick="carregarClientes()">üîÑ Atualizar Lista</button>
                </div>
            </div>
            
            <div class="footer">
                <p>üöÄ ArcSat Industrial - Powered by Azure AI | Status: <span id="status">Verificando...</span></p>
            </div>

            <script>
                // Verificar status do sistema
                fetch('/health')
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById('status').textContent = data.azure_ai ? '‚úÖ IA Online' : '‚ö†Ô∏è IA Offline';
                    });

                // Carregar lista de clientes
                function carregarClientes() {
                    fetch('/api/clientes')
                        .then(r => r.json())
                        .then(data => {
                            const container = document.getElementById('clientes');
                            if (data.clientes.length === 0) {
                                container.innerHTML = '<p>Nenhum cliente cadastrado ainda.</p>';
                                return;
                            }
                            
                            container.innerHTML = data.clientes.map(cliente => 
                                '<div class="cliente-item">' +
                                '<h4>' + cliente.nomeEmpresa + ' <span class="status ativo">' + cliente.status + '</span></h4>' +
                                '<p><strong>Setor:</strong> ' + cliente.setor + ' | <strong>Funcion√°rios:</strong> ' + cliente.numeroFuncionarios + '</p>' +
                                '<p><strong>Etapa:</strong> ' + cliente.etapaConsultoria + '</p>' +
                                '<button class="btn" onclick="verDiagnostico(\\'' + cliente.id + '\\')">üîç Diagn√≥stico</button>' +
                                '<button class="btn" onclick="verRelatorio(\\'' + cliente.id + '\\')">üìä Relat√≥rio</button>' +
                                '</div>'
                            ).join('');
                        });
                }

                function novoCliente() {
                    const nome = prompt('Nome da empresa:');
                    const setor = prompt('Setor (ex: metalurgica, automotiva, quimica):');
                    const funcionarios = prompt('N√∫mero de funcion√°rios:');
                    const desafios = prompt('Principais desafios:');
                    
                    if (nome && setor && funcionarios) {
                        fetch('/api/clientes/novo', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                nomeEmpresa: nome,
                                setor: setor,
                                numeroFuncionarios: parseInt(funcionarios),
                                desafios: desafios
                            })
                        })
                        .then(r => r.json())
                        .then(data => {
                            alert('‚úÖ Cliente criado com sucesso!');
                            carregarClientes();
                        });
                    }
                }

                function gerarDiagnostico() {
                    const clienteId = prompt('ID do cliente (ou deixe vazio para o √∫ltimo):');
                    if (!clienteId) {
                        alert('Primeiro cadastre um cliente');
                        return;
                    }
                    
                    fetch('/api/clientes/' + clienteId + '/diagnostico')
                        .then(r => r.json())
                        .then(data => {
                            alert('‚úÖ Diagn√≥stico gerado! Verifique o console para detalhes.');
                            console.log('Diagn√≥stico:', data.diagnostico);
                        });
                }

                function verDiagnostico(clienteId) {
                    fetch('/api/clientes/' + clienteId + '/diagnostico')
                        .then(r => r.json())
                        .then(data => {
                            alert('Diagn√≥stico gerado! Verifique o console para detalhes.');
                            console.log('Diagn√≥stico:', data.diagnostico);
                        });
                }

                function verRelatorio(clienteId) {
                    fetch('/api/clientes/' + clienteId + '/relatorio')
                        .then(r => r.json())
                        .then(data => {
                            alert('Relat√≥rio gerado! Verifique o console para detalhes.');
                            console.log('Relat√≥rio:', data.relatorio);
                        });
                }

                // Carregar clientes ao iniciar
                carregarClientes();
            </script>
        </body>
        </html>
        `;
    }

    start() {
        this.app.listen(this.port, () => {
            console.log(`üöÄ ArcSat Industrial - Gest√£o de Clientes`);
            console.log(`üåê Servidor rodando em: http://localhost:${this.port}`);
            console.log(`üìä Dashboard dispon√≠vel em: http://localhost:${this.port}/dashboard`);
            console.log(`ü§ñ Azure AI: ${this.openaiClient ? 'Conectado' : 'Offline'}`);
            console.log(`‚è∞ Iniciado em: ${new Date().toLocaleString('pt-BR')}`);
        });
    }
}

// Inicializar o sistema
const gestaoClientes = new GestaoClientesIndustrial();
gestaoClientes.start();