# MongoDB Configuration - ArcSat CRM

## üéØ Vis√£o Geral

Este documento descreve a configura√ß√£o completa do MongoDB Atlas para o sistema ArcSat CRM, incluindo integra√ß√£o com Azure e GitHub.

## üìä Arquitetura do Banco

### Estrutura Principal

```
arcsat-production/
‚îú‚îÄ‚îÄ companies/          # Empresas (collection principal)
‚îú‚îÄ‚îÄ users/             # Usu√°rios (relacionado √† companies)
‚îú‚îÄ‚îÄ customers/         # Clientes das empresas
‚îú‚îÄ‚îÄ sales/            # Vendas e transa√ß√µes
‚îú‚îÄ‚îÄ products/         # Produtos e servi√ßos
‚îú‚îÄ‚îÄ interactions/     # Intera√ß√µes com clientes
‚îî‚îÄ‚îÄ audit_logs/       # Logs de auditoria
```

### Modelos Principais

#### Company (Empresa)
```typescript
interface ICompany {
  _id: ObjectId;
  name: string;                    // Nome da empresa
  cnpj: string;                   // CNPJ formatado (validado)
  email: string;                  // Email corporativo
  phone: string;                  // Telefone formatado
  address: IAddress;              // Endere√ßo completo
  customDomain?: string;          // Dom√≠nio personalizado
  subscription: ISubscription;    // Dados da assinatura
  settings: Record<string, any>;  // Configura√ß√µes personalizadas
  createdAt: Date;
  updatedAt: Date;
}
```

#### User (Usu√°rio)
```typescript
interface IUser {
  _id: ObjectId;
  name: string;              // Nome completo
  email: string;             // Email √∫nico
  password: string;          // Hash bcrypt
  role: UserRole;            // ADMIN | USER | VIEWER
  companyId: ObjectId;       // Refer√™ncia √† empresa
  avatar?: string;           // URL do avatar
  isActive: boolean;         // Status ativo/inativo
  lastLogin?: Date;          // √öltimo acesso
  createdAt: Date;
  updatedAt: Date;
}
```

## üîß Configura√ß√£o

### 1. Vari√°veis de Ambiente

```bash
# MongoDB Atlas
MONGO_URI=mongodb+srv://arcsat-admin:password@arcsat-cluster.mongodb.net/arcsat-production?retryWrites=true&w=majority
MONGODB_USERNAME=arcsat-admin
MONGODB_PASSWORD=password
MONGODB_DATABASE=arcsat-production
MONGODB_CLUSTER=arcsat-cluster

# Pool de Conex√µes
MONGODB_MAX_POOL_SIZE=50
MONGODB_MIN_POOL_SIZE=5
MONGODB_MAX_IDLE_TIME=30000
MONGODB_SERVER_SELECTION_TIMEOUT=5000

# Azure Integration
AZURE_KEYVAULT_URL=https://arcsat-keyvault.vault.azure.net/
AZURE_MONGODB_SECRET_NAME=mongodb-connection-string

# Monitoring
MONGODB_ENABLE_MONITORING=true
MONGODB_SLOW_QUERY_THRESHOLD=100
MONGODB_LOG_LEVEL=info
```

### 2. Conex√£o Otimizada

```typescript
const connectionOptions = {
  serverSelectionTimeoutMS: 5000,
  heartbeatFrequencyMS: 10000,
  maxPoolSize: 50,
  minPoolSize: 5,
  maxIdleTimeMS: 30000,
  bufferMaxEntries: 0,
  bufferCommands: false,
  compressors: ['zlib'],
  retryWrites: true,
  w: 'majority',
  readPreference: 'primary',
};
```

## üìà √çndices Otimizados

### Users Collection
```javascript
// √çndices √∫nicos
{ email: 1 }              // √önico
{ email: 1, companyId: 1 } // Composto √∫nico

// √çndices de performance
{ companyId: 1 }          // Queries por empresa
{ isActive: 1 }           // Filtros de status
{ createdAt: 1 }          // Ordena√ß√£o temporal
```

### Companies Collection
```javascript
// √çndices √∫nicos
{ cnpj: 1 }               // √önico

// √çndices compostos
{ "subscription.plan": 1, "subscription.status": 1 }
{ "subscription.status": 1 }

// Text search
{ name: "text", email: "text" }

// Temporal
{ createdAt: 1 }
```

## üöÄ Scripts Dispon√≠veis

### Inicializa√ß√£o e Testes
```bash
# Configurar MongoDB completamente
npm run db:setup

# Inicializar com dados de exemplo
npm run db:init

# Executar testes completos
npm run db:test

# Health check r√°pido
npm run db:health

# Popular dados de exemplo
npm run db:seed
```

### Scripts Detalhados

#### `npm run db:setup`
- Instala depend√™ncias necess√°rias
- Configura vari√°veis de ambiente
- Cria scripts de health check
- Configura Azure Key Vault
- Atualiza GitHub Actions

#### `npm run db:init`
- Conecta ao MongoDB Atlas
- Cria √≠ndices otimizados
- Popula dados de exemplo
- Valida conex√£o e performance

#### `npm run db:test`
- Testa conex√£o e health check
- Valida modelos e relacionamentos
- Executa opera√ß√µes CRUD
- Mede performance de queries
- Testa valida√ß√µes e constraints

## üîê Seguran√ßa

### Autentica√ß√£o
- **Usu√°rio**: `arcsat-admin`
- **M√©todo**: MongoDB Atlas Authentication
- **Rede**: IP Whitelist configurado
- **Criptografia**: TLS 1.2+ obrigat√≥rio

### Backup e Recovery
- **Frequency**: Daily automated backups
- **Retention**: 30 days
- **Location**: Azure Blob Storage
- **Encryption**: AES-256

### Auditoria
```typescript
// Logs autom√°ticos de todas as opera√ß√µes
interface AuditLog {
  userId: ObjectId;
  companyId: ObjectId;
  action: string;        // CREATE, UPDATE, DELETE
  collection: string;    // companies, users, etc
  documentId: ObjectId;
  changes: Record<string, any>;
  timestamp: Date;
  ipAddress: string;
  userAgent: string;
}
```

## üåê Integra√ß√£o Azure

### Key Vault
```typescript
// Armazenamento seguro de connection strings
const keyVault = new SecretClient(
  'https://arcsat-keyvault.vault.azure.net/',
  new DefaultAzureCredential()
);

const mongoUri = await keyVault.getSecret('mongodb-connection-string');
```

### Application Insights
```typescript
// Monitoramento autom√°tico de queries
const telemetryClient = new TelemetryClient({
  instrumentationKey: process.env.APPINSIGHTS_INSTRUMENTATIONKEY
});

// Log de queries lentas
if (queryTime > 100) {
  telemetryClient.trackDependency({
    name: 'MongoDB Query',
    data: queryString,
    duration: queryTime,
    success: true,
    dependencyTypeName: 'MongoDB'
  });
}
```

## üîÑ GitHub Integration

### Actions Workflow
```yaml
name: MongoDB Health Check

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */6 * * *'  # A cada 6 horas

jobs:
  mongodb-health:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: MongoDB Health Check
      env:
        MONGO_URI: ${{ secrets.MONGO_URI }}
      run: npm run db:health
```

### Secrets Necess√°rios
- `MONGO_URI`: Connection string completa
- `AZURE_CLIENT_ID`: Azure service principal
- `AZURE_CLIENT_SECRET`: Azure client secret
- `AZURE_TENANT_ID`: Azure tenant ID

## üìä Monitoramento

### M√©tricas Chave
- **Connection Pool**: Uso atual vs m√°ximo
- **Query Performance**: Queries > 100ms
- **Index Usage**: Efici√™ncia dos √≠ndices
- **Storage**: Uso de espa√ßo por collection
- **Throughput**: Opera√ß√µes por segundo

### Alertas Configurados
- Pool de conex√µes > 80% utiliza√ß√£o
- Queries lentas > 1 segundo
- Falhas de conex√£o > 5 por minuto
- Storage > 80% da quota

## üîß Troubleshooting

### Problemas Comuns

#### Conex√£o Falhando
```bash
# Verificar vari√°veis de ambiente
echo $MONGO_URI

# Testar conectividade
npm run db:health

# Verificar whitelist de IPs no Atlas
```

#### Performance Lenta
```bash
# Verificar queries lentas
db.setProfilingLevel(2, { slowms: 100 })

# Analisar uso de √≠ndices
db.collection.explain("executionStats").find({...})

# Verificar pool de conex√µes
db.serverStatus().connections
```

#### Dados Inconsistentes
```bash
# Verificar integridade
npm run db:test

# Recriar √≠ndices
db.collection.reIndex()

# Validar documentos
db.collection.validate()
```

## üìù Logs e Debugging

### Configura√ß√£o de Logs
```typescript
// winston logger configuration
const logger = winston.createLogger({
  level: process.env.MONGODB_LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/mongodb.log' }),
    new winston.transports.Console()
  ]
});
```

### Debug Queries
```typescript
// Habilitar debug do mongoose
mongoose.set('debug', process.env.NODE_ENV === 'development');

// Log personalizado de queries
mongoose.connection.on('connected', () => {
  logger.info('MongoDB conectado');
});

mongoose.connection.on('error', (error) => {
  logger.error('Erro MongoDB:', error);
});
```

## üéØ Best Practices

### Performance
1. **Use √≠ndices apropriados** para todas as queries frequentes
2. **Limite resultados** com `.limit()` em queries grandes
3. **Use proje√ß√£o** para retornar apenas campos necess√°rios
4. **Evite regex** em campos n√£o indexados
5. **Use aggregation pipeline** para queries complexas

### Estrutura de Dados
1. **Embedar documentos** que sempre s√£o acessados juntos
2. **Referenciar documentos** que podem crescer indefinidamente
3. **Desnormalizar** dados que s√£o lidos frequentemente
4. **Normalizar** dados que s√£o atualizados frequentemente

### Seguran√ßa
1. **Sempre validar** input do usu√°rio
2. **Usar prepared statements** (mongoose faz automaticamente)
3. **Criptografar dados sens√≠veis** antes de armazenar
4. **Implementar rate limiting** por usu√°rio/IP
5. **Auditar todas as opera√ß√µes** cr√≠ticas

---

## üìû Suporte

Para problemas relacionados ao MongoDB:

1. **Verificar logs**: `logs/mongodb.log`
2. **Executar testes**: `npm run db:test`
3. **Verificar status**: `npm run db:health`
4. **Consultar documenta√ß√£o**: [MongoDB Atlas Docs](https://docs.atlas.mongodb.com/)

**Equipe √Åvila Ops**
- Email: suporte@avilaops.com
- GitHub: [@avilaops](https://github.com/avilaops)
- Discord: ArcSat Community