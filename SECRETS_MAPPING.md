# üîç Mapa de Secrets - GitHub Actions

Este documento mapeia quais secrets s√£o usados em cada workflow.

---

## üìä Tabela de Secrets por Workflow

| Secret | azure-deploy.yml | ci-cd.yml | main.yml | Obrigat√≥rio? |
|--------|-----------------|-----------|----------|--------------|
| **AZURE_CREDENTIALS** | ‚úÖ | ‚úÖ | ‚ùå | ‚úÖ Sim |
| **MONGO_ATLAS_URI** | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ Sim |
| **JWT_SECRET** | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ Sim |
| **OPENAI_API_KEY** | ‚úÖ | ‚ùå | ‚ùå | ‚ö†Ô∏è Opcional |
| **CLOUDFLARE_API_TOKEN** | ‚úÖ | ‚ùå | ‚ùå | ‚ö†Ô∏è Opcional |
| **AZURE_WEBAPP_PUBLISH_PROFILE_API** | ‚ùå | ‚ùå | ‚úÖ | ‚ùå N√£o* |
| **AZURE_STATIC_WEB_APPS_API_TOKEN** | ‚ùå | ‚ùå | ‚úÖ | ‚ùå N√£o* |

**Legendas:**
- ‚úÖ = Usado pelo workflow
- ‚ùå = N√£o usado pelo workflow  
- ‚ö†Ô∏è = Opcional mas recomendado
- *N√£o = Apenas se usar o workflow `main.yml` (alternativo)

---

## üéØ Workflow Principal: azure-deploy.yml

**Arquivo:** `.github/workflows/azure-deploy.yml`

**Status:** üü¢ Ativo e Recomendado

**Gatilhos:**
- Push para `main`
- Push para `copilot/set-up-copilot-instructions`
- Altera√ß√µes em: `frontend/**`, `src/**`, `package.json`, workflow file
- Manual via `workflow_dispatch`

**Secrets Usados:**

### 1. AZURE_CREDENTIALS (Obrigat√≥rio)
```yaml
# Arquivo: .github/workflows/azure-deploy.yml
# Linhas 61-64
- name: Login to Azure
  uses: azure/login@v1
  with:
    creds: ${{ secrets.AZURE_CREDENTIALS }}
```

**Uso:** Autentica√ß√£o no Azure para deploy

---

### 2. MONGO_ATLAS_URI (Obrigat√≥rio)
```yaml
# Arquivo: .github/workflows/azure-deploy.yml
# Linha 80
MONGODB_URI="${{ secrets.MONGO_ATLAS_URI }}"
```

**Uso:** Connection string para MongoDB Atlas

---

### 3. JWT_SECRET (Obrigat√≥rio)
```yaml
# Arquivo: .github/workflows/azure-deploy.yml
# Linha 81
JWT_SECRET="${{ secrets.JWT_SECRET }}"
```

**Uso:** Chave secreta para gera√ß√£o de tokens JWT

---

### 4. OPENAI_API_KEY (Opcional)
```yaml
# Arquivo: .github/workflows/azure-deploy.yml
# Linha 82
OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
```

**Uso:** API key para funcionalidades de IA

**Nota:** Se n√£o usar, configure como placeholder no Azure

---

### 5. CLOUDFLARE_API_TOKEN (Opcional)
```yaml
# Arquivo: .github/workflows/azure-deploy.yml
# Linha 83
CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
```

**Uso:** Token para gerenciar DNS/CDN via Cloudflare

**Nota:** Se n√£o usar Cloudflare, pode omitir ou usar placeholder

---

## üîÑ Workflow Secund√°rio: ci-cd.yml

**Arquivo:** `.github/workflows/ci-cd.yml`

**Status:** üü¢ Ativo

**Gatilhos:**
- Push para `main` ou `develop`
- Pull requests para `main` ou `develop`

**Secrets Usados:**

### AZURE_CREDENTIALS (Obrigat√≥rio)
```yaml
# Arquivo: .github/workflows/ci-cd.yml
# Linhas 73-76
- name: Login to Azure
  uses: azure/login@v1
  with:
    creds: ${{ secrets.AZURE_CREDENTIALS }}
```

**Uso:** Deploy no job final (apenas se for main branch)

---

## üîÄ Workflow Alternativo: main.yml

**Arquivo:** `.github/workflows/main.yml`

**Status:** ‚ö†Ô∏è Alternativo (n√£o usar junto com azure-deploy.yml)

**Gatilhos:**
- Push para `main`
- Pull requests para `main`

**Secrets Usados:**

### 1. AZURE_WEBAPP_PUBLISH_PROFILE_API
```yaml
# Arquivo: .github/workflows/main.yml
# Linha 32
publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_API }}
```

**Uso:** Deploy da API usando publish profile (m√©todo alternativo)

---

### 2. AZURE_STATIC_WEB_APPS_API_TOKEN
```yaml
# Arquivo: .github/workflows/main.yml
# Linha 58
azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
```

**Uso:** Deploy do frontend em Azure Static Web Apps

---

## üéØ Recomenda√ß√£o de Uso

### Cen√°rio Recomendado: Usar azure-deploy.yml

‚úÖ **Vantagens:**
- Deploy completo (backend + frontend) em um workflow
- Usa service principal (mais seguro)
- Configura√ß√£o centralizada de app settings
- Melhor controle sobre o deploy

**Secrets necess√°rios:**
```
‚úÖ AZURE_CREDENTIALS
‚úÖ MONGO_ATLAS_URI
‚úÖ JWT_SECRET
‚ö†Ô∏è OPENAI_API_KEY (opcional)
‚ö†Ô∏è CLOUDFLARE_API_TOKEN (opcional)
```

---

### Cen√°rio Alternativo: Usar main.yml

‚ö†Ô∏è **Quando usar:**
- Se preferir deploy separado de API e Frontend
- Se usar Azure Static Web Apps para o frontend

**Secrets necess√°rios:**
```
‚úÖ AZURE_WEBAPP_PUBLISH_PROFILE_API
‚úÖ AZURE_STATIC_WEB_APPS_API_TOKEN
```

**Nota:** Este m√©todo N√ÉO configura automaticamente as vari√°veis de ambiente no Azure. Voc√™ precisar√° configur√°-las manualmente.

---

## üìã Checklist de Configura√ß√£o

### Para azure-deploy.yml (Recomendado)

- [ ] `AZURE_CREDENTIALS` adicionado
- [ ] `MONGO_ATLAS_URI` adicionado
- [ ] `JWT_SECRET` adicionado
- [ ] `OPENAI_API_KEY` adicionado (ou placeholder)
- [ ] `CLOUDFLARE_API_TOKEN` adicionado (ou remover do workflow)
- [ ] Azure Web App criado: `arcsat-crm`
- [ ] Resource Group criado: `rg-arcsat-crm`

### Para main.yml (Alternativo)

- [ ] `AZURE_WEBAPP_PUBLISH_PROFILE_API` adicionado
- [ ] `AZURE_STATIC_WEB_APPS_API_TOKEN` adicionado
- [ ] Azure Web App criado: `arcsat-api`
- [ ] Azure Static Web App criado
- [ ] Vari√°veis de ambiente configuradas manualmente no Azure

---

## üîß Como Obter Cada Secret

### AZURE_CREDENTIALS
```powershell
az ad sp create-for-rbac `
  --name "github-actions-arcsat" `
  --role contributor `
  --scopes /subscriptions/<sub-id>/resourceGroups/rg-arcsat-crm `
  --sdk-auth
```

### AZURE_WEBAPP_PUBLISH_PROFILE_API
```powershell
az webapp deployment list-publishing-profiles `
  --name arcsat-api `
  --resource-group rg-arcsat-crm `
  --xml
```

### AZURE_STATIC_WEB_APPS_API_TOKEN
```
Azure Portal > Static Web App > Manage deployment token
```

---

## üîí Seguran√ßa

### Boas Pr√°ticas

‚úÖ **Fa√ßa:**
- Use `AZURE_CREDENTIALS` (service principal) para maior seguran√ßa
- Rotacione secrets a cada 90 dias
- Use princ√≠pio do menor privil√©gio
- Configure secrets no GitHub, nunca no c√≥digo

‚ùå **N√£o fa√ßa:**
- N√£o commite secrets no c√≥digo
- N√£o compartilhe secrets publicamente
- N√£o use a mesma credencial em m√∫ltiplos ambientes
- N√£o d√™ mais permiss√µes do que necess√°rio

---

## üìä Compara√ß√£o de M√©todos de Deploy

| Aspecto | azure-deploy.yml | main.yml |
|---------|-----------------|----------|
| **Complexidade** | Baixa | M√©dia |
| **Secrets necess√°rios** | 5 | 2 |
| **Auto-config** | Sim ‚úÖ | N√£o ‚ùå |
| **Deploy unificado** | Sim ‚úÖ | N√£o ‚ùå |
| **Separa√ß√£o API/Frontend** | N√£o ‚ùå | Sim ‚úÖ |
| **Seguran√ßa** | Alta üîí | M√©dia üîí |
| **Recomendado** | ‚úÖ Sim | ‚ö†Ô∏è Casos espec√≠ficos |

---

## üöÄ Pr√≥ximos Passos

1. ‚úÖ Escolha qual workflow usar (recomendado: `azure-deploy.yml`)
2. ‚úÖ Configure os secrets necess√°rios
3. ‚úÖ Verifique se os recursos Azure existem
4. ‚úÖ Fa√ßa push para `main`
5. ‚úÖ Acompanhe o deploy: https://github.com/avilaops/ArcSat/actions

---

## üìö Documenta√ß√£o Relacionada

- [Quick Start](./QUICK_SECRETS_SETUP.md) - Setup r√°pido
- [Guia Completo](./GITHUB_SECRETS_SETUP.md) - Configura√ß√£o detalhada
- [Checklist](./SETUP_CHECKLIST.md) - Passo a passo
- [Workflow Diagram](./DEPLOY_WORKFLOW.md) - Fluxo visual

---

**√öltima atualiza√ß√£o:** 27/10/2025  
**Vers√£o:** 1.0.0
