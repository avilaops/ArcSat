import Database from '../src/config/database.js';
import User from '../src/models/User.js';
import Company from '../src/models/Company.js';
import logger from '../src/config/logger.js';
import { SubscriptionPlan, SubscriptionStatus, UserRole } from '../src/types/index.js';

// Dados de exemplo para inicializa√ß√£o
const sampleCompanies = [
  {
    name: '√Åvila Ops Tecnologia Ltda',
    cnpj: '12.345.678/0001-90',
    email: 'contato@avilaops.com',
    phone: '(11) 99999-9999',
    address: {
      street: 'Av. Paulista',
      number: '1000',
      complement: 'Sala 101',
      neighborhood: 'Bela Vista',
      city: 'S√£o Paulo',
      state: 'SP',
      zipCode: '01310-100',
    },
    customDomain: 'avilaops.arcsat.com.br',
    subscription: {
      plan: SubscriptionPlan.ENTERPRISE,
      status: SubscriptionStatus.ACTIVE,
      startDate: new Date('2024-01-01'),
      endDate: new Date('2025-12-31'),
    },
    settings: {
      theme: 'dark',
      timezone: 'America/Sao_Paulo',
      language: 'pt-BR',
      features: {
        aiAssistant: true,
        advancedReports: true,
        customIntegrations: true,
      },
    },
  },
  {
    name: 'Ind√∫stria Beta S.A.',
    cnpj: '98.765.432/0001-10',
    email: 'admin@industriabeta.com.br',
    phone: '(11) 88888-8888',
    address: {
      street: 'Rua das Ind√∫strias',
      number: '500',
      neighborhood: 'Distrito Industrial',
      city: 'S√£o Bernardo do Campo',
      state: 'SP',
      zipCode: '09600-000',
    },
    subscription: {
      plan: SubscriptionPlan.PRO,
      status: SubscriptionStatus.ACTIVE,
      startDate: new Date('2024-06-01'),
      endDate: new Date('2025-06-01'),
    },
    settings: {
      theme: 'light',
      timezone: 'America/Sao_Paulo',
      language: 'pt-BR',
      features: {
        aiAssistant: true,
        advancedReports: false,
        customIntegrations: false,
      },
    },
  },
  {
    name: 'Startup Gamma Tech',
    cnpj: '11.222.333/0001-44',
    email: 'hello@gammatech.io',
    phone: '(11) 77777-7777',
    address: {
      street: 'Rua dos Empreendedores',
      number: '123',
      complement: 'Coworking Space',
      neighborhood: 'Vila Ol√≠mpia',
      city: 'S√£o Paulo',
      state: 'SP',
      zipCode: '04551-060',
    },
    subscription: {
      plan: SubscriptionPlan.FREE,
      status: SubscriptionStatus.TRIAL,
      startDate: new Date(),
    },
    settings: {
      theme: 'auto',
      timezone: 'America/Sao_Paulo',
      language: 'pt-BR',
      features: {
        aiAssistant: false,
        advancedReports: false,
        customIntegrations: false,
      },
    },
  },
];

const sampleUsers = [
  {
    name: 'Alexandre √Åvila',
    email: 'alexandre@avilaops.com',
    password: 'ArcSat2024!',
    role: UserRole.ADMIN,
    avatar: 'https://avatars.githubusercontent.com/avilaops',
  },
  {
    name: 'Maria Silva',
    email: 'maria@industriabeta.com.br',
    password: 'Industrial2024!',
    role: UserRole.ADMIN,
  },
  {
    name: 'Jo√£o Santos',
    email: 'joao@industriabeta.com.br',
    password: 'Manager2024!',
    role: UserRole.USER,
  },
  {
    name: 'Ana Costa',
    email: 'ana@gammatech.io',
    password: 'Startup2024!',
    role: UserRole.ADMIN,
  },
];

async function initializeDatabase(): Promise<void> {
  try {
    logger.info('üöÄ Iniciando configura√ß√£o do banco de dados...');
    
    // Conectar ao banco
    await Database.connect();
    
    // Limpar dados existentes (cuidado em produ√ß√£o!)
    if (process.env.NODE_ENV !== 'production') {
      logger.info('üßπ Limpando dados existentes...');
      await User.deleteMany({});
      await Company.deleteMany({});
    }
    
    // Criar empresas
    logger.info('üè¢ Criando empresas de exemplo...');
    const createdCompanies = await Company.insertMany(sampleCompanies);
    logger.info(`‚úÖ ${createdCompanies.length} empresas criadas`);
    
    // Criar usu√°rios associados √†s empresas
    logger.info('üë• Criando usu√°rios de exemplo...');
    const usersWithCompanyIds = sampleUsers.map((user, index) => ({
      ...user,
      companyId: createdCompanies[Math.floor(index / 2)]._id, // 2 usu√°rios por empresa (exceto √∫ltima)
    }));
    
    const createdUsers = await User.insertMany(usersWithCompanyIds);
    logger.info(`‚úÖ ${createdUsers.length} usu√°rios criados`);
    
    // Verificar sa√∫de do banco
    const healthCheck = await Database.healthCheck();
    logger.info('üè• Status do banco de dados:', healthCheck);
    
    // Estat√≠sticas finais
    const totalCompanies = await Company.countDocuments();
    const totalUsers = await User.countDocuments();
    const activeCompanies = await Company.findActiveCompanies();
    
    logger.info('üìä Estat√≠sticas finais:', {
      totalCompanies,
      totalUsers,
      activeCompanies: activeCompanies.length,
      database: 'arcsat-production',
      status: 'ready',
    });
    
    logger.info('‚úÖ Banco de dados configurado com sucesso!');
    
  } catch (error) {
    logger.error('‚ùå Erro ao configurar banco de dados:', error);
    throw error;
  }
}

// Executar se chamado diretamente
if (import.meta.url === `file://${process.argv[1]}`) {
  initializeDatabase()
    .then(() => {
      logger.info('üéâ Configura√ß√£o conclu√≠da!');
      process.exit(0);
    })
    .catch((error) => {
      logger.error('üí• Falha na configura√ß√£o:', error);
      process.exit(1);
    });
}

export default initializeDatabase;