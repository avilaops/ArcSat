// Teste da integra√ß√£o SEFAZ para ArcSat Industrial
import IntegradorSEFAZ from '../src/services/integrador-sefaz.js';

const colors = {
    green: '\x1b[32m',
    red: '\x1b[31m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    reset: '\x1b[0m'
};

async function testarIntegracaoSEFAZ() {
    console.log(`${colors.blue}üß™ Testando Integra√ß√£o SEFAZ/ReceitaWS${colors.reset}`);
    
    const integrador = new IntegradorSEFAZ();
    
    // CNPJs de teste (empresas reais para valida√ß√£o)
    const cnpjsTeste = [
        '11.222.333/0001-81', // CNPJ inv√°lido para teste
        '07.526.557/0001-00', // TIM Celular (exemplo real)
        '09.073.477/0001-04', // Magazine Luiza (exemplo real)
        '33.000.167/0001-01'  // Globo (exemplo real)
    ];
    
    console.log(`${colors.blue}üìã Testando ${cnpjsTeste.length} CNPJs...${colors.reset}\n`);
    
    for (let i = 0; i < cnpjsTeste.length; i++) {
        const cnpj = cnpjsTeste[i];
        console.log(`${colors.blue}${i + 1}. Testando CNPJ: ${cnpj}${colors.reset}`);
        
        try {
            // Primeiro validar o CNPJ
            const validacao = integrador.validarCNPJ(cnpj);
            console.log(`   Valida√ß√£o: ${validacao.valido ? '‚úÖ V√°lido' : '‚ùå ' + validacao.erro}`);
            
            if (!validacao.valido) {
                console.log(`${colors.yellow}   ‚è≠Ô∏è  Pulando consulta SEFAZ (CNPJ inv√°lido)${colors.reset}\n`);
                continue;
            }
            
            // Buscar dados na SEFAZ
            console.log(`   üîç Consultando SEFAZ...`);
            const dadosSEFAZ = await integrador.buscarDadosSEFAZ(cnpj);
            
            console.log(`${colors.green}   ‚úÖ Sucesso!${colors.reset}`);
            console.log(`   üìã Empresa: ${dadosSEFAZ.razao_social}`);
            console.log(`   üè¢ Situa√ß√£o: ${dadosSEFAZ.situacao_cadastral}`);
            console.log(`   üè≠ Setor: ${dadosSEFAZ.analise_industrial.setor_identificado}`);
            console.log(`   üéØ Especializa√ß√£o: ${dadosSEFAZ.analise_industrial.especializacao_recomendada}`);
            console.log(`   üí∞ Potencial: ${dadosSEFAZ.analise_industrial.potencial_cliente ? 'Alto' : 'M√©dio'}`);
            
            // Testar mapeamento para cliente
            const dadosCliente = integrador.mapearParaSchemaCliente(dadosSEFAZ);
            console.log(`   üóÇÔ∏è  Mapeamento: ${Object.keys(dadosCliente).length} campos`);
            
            // Mostrar an√°lise industrial
            if (dadosSEFAZ.analise_industrial.observacoes.length > 0) {
                console.log(`   üí° Observa√ß√µes:`);
                dadosSEFAZ.analise_industrial.observacoes.forEach(obs => {
                    console.log(`      - ${obs}`);
                });
            }
            
        } catch (error) {
            console.log(`${colors.red}   ‚ùå Erro: ${error.message}${colors.reset}`);
            
            if (error.message.includes('n√£o encontrado')) {
                console.log(`${colors.yellow}   ‚ÑπÔ∏è  CNPJ n√£o existe na base da Receita Federal${colors.reset}`);
            } else if (error.message.includes('Muitas consultas')) {
                console.log(`${colors.yellow}   ‚è∞ Rate limit atingido - aguarde alguns minutos${colors.reset}`);
                break; // Parar teste se atingir rate limit
            }
        }
        
        console.log(''); // Linha em branco
        
        // Delay entre consultas para evitar rate limit
        if (i < cnpjsTeste.length - 1) {
            console.log(`${colors.blue}   ‚è≥ Aguardando 2 segundos...${colors.reset}`);
            await new Promise(resolve => setTimeout(resolve, 2000));
        }
    }
    
    console.log(`${colors.green}üéâ Teste de integra√ß√£o SEFAZ conclu√≠do!${colors.reset}`);
    console.log(`${colors.blue}üìñ Pr√≥ximos passos:${colors.reset}`);
    console.log(`   1. Configure MONGODB_URI em .env`);
    console.log(`   2. Execute: npm run industrial:start`);
    console.log(`   3. Acesse: http://localhost:5000/dashboard`);
    console.log(`   4. Teste busca por CNPJ no dashboard`);
}

// Executar teste
testarIntegracaoSEFAZ().catch(console.error);