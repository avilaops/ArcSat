import Database from '../src/config/database.js';
import Company from '../src/models/Company.js';
import User from '../src/models/User.js';
import logger from '../src/config/logger.js';
import { SubscriptionPlan, SubscriptionStatus, UserRole } from '../src/types/index.js';

/**
 * Script de teste completo do MongoDB
 * Valida conex√£o, modelos, opera√ß√µes CRUD e performance
 */

async function testMongoDB(): Promise<void> {
  const startTime = Date.now();
  
  try {
    logger.info('üß™ Iniciando testes do MongoDB...');
    
    // 1. Teste de Conex√£o
    logger.info('üì° Testando conex√£o...');
    await Database.connect();
    
    if (!Database.isDbConnected()) {
      throw new Error('Falha na conex√£o com MongoDB');
    }
    logger.info('‚úÖ Conex√£o estabelecida com sucesso');
    
    // 2. Health Check
    logger.info('üè• Executando health check...');
    const health = await Database.healthCheck();
    logger.info('Status do banco:', health);
    
    if (health.status !== 'healthy') {
      throw new Error('Health check falhou');
    }
    
    // 3. Teste de Modelos - Company
    logger.info('üè¢ Testando modelo Company...');
    
    const testCompany = {
      name: 'Empresa Teste MongoDB',
      cnpj: '12345678000190',
      email: 'teste@mongotest.com',
      phone: '11999999999',
      address: {
        street: 'Rua Teste',
        number: '123',
        neighborhood: 'Bairro Teste',
        city: 'S√£o Paulo',
        state: 'SP',
        zipCode: '01234567',
      },
      subscription: {
        plan: SubscriptionPlan.PRO,
        status: SubscriptionStatus.ACTIVE,
        startDate: new Date(),
      },
    };
    
    // Criar empresa
    const company = new Company(testCompany);
    await company.save();
    logger.info('‚úÖ Empresa criada:', company.id);
    
    // Testar m√©todo est√°tico
    const foundCompany = await Company.findByCnpj('12.345.678/0001-90');
    if (foundCompany) {
      logger.info('‚úÖ Busca por CNPJ funcionando');
    }
    
    // 4. Teste de Modelos - User
    logger.info('üë§ Testando modelo User...');
    
    const testUser = {
      name: 'Usu√°rio Teste',
      email: 'usuario@mongotest.com',
      password: 'SenhaSegura123!',
      role: UserRole.USER,
      companyId: company._id,
    };
    
    // Criar usu√°rio
    const user = new User(testUser);
    await user.save();
    logger.info('‚úÖ Usu√°rio criado:', user.id);
    
    // Testar m√©todo de compara√ß√£o de senha
    const isPasswordValid = await user.comparePassword('SenhaSegura123!');
    if (isPasswordValid) {
      logger.info('‚úÖ Hash de senha funcionando');
    } else {
      throw new Error('Falha na verifica√ß√£o de senha');
    }
    
    // 5. Teste de Relacionamentos
    logger.info('üîó Testando relacionamentos...');
    
    const userWithCompany = await User.findById(user._id).populate('companyId');
    if (userWithCompany && userWithCompany.companyId) {
      logger.info('‚úÖ Relacionamento User -> Company funcionando');
    }
    
    // 6. Teste de Consultas Complexas
    logger.info('üîç Testando consultas complexas...');
    
    // Buscar empresas ativas
    const activeCompanies = await Company.findActiveCompanies();
    logger.info(`‚úÖ Encontradas ${activeCompanies.length} empresas ativas`);
    
    // Buscar por plano
    const proCompanies = await Company.findBySubscriptionPlan(SubscriptionPlan.PRO);
    logger.info(`‚úÖ Encontradas ${proCompanies.length} empresas PRO`);
    
    // 7. Teste de Performance
    logger.info('‚ö° Testando performance...');
    
    const performanceStart = Date.now();
    
    // Criar m√∫ltiplos documentos
    const testCompanies = Array.from({ length: 10 }, (_, i) => ({
      name: `Empresa Performance ${i}`,
      cnpj: `${String(i).padStart(11, '0')}0001${String(i).padStart(2, '0')}`,
      email: `perf${i}@test.com`,
      phone: `119999999${String(i).padStart(2, '0')}`,
      address: {
        street: `Rua Performance ${i}`,
        number: `${i}00`,
        neighborhood: 'Bairro Performance',
        city: 'S√£o Paulo',
        state: 'SP',
        zipCode: `0123${String(i).padStart(3, '0')}`,
      },
    }));
    
    const createdCompanies = await Company.insertMany(testCompanies);
    const performanceTime = Date.now() - performanceStart;
    
    logger.info(`‚úÖ Criadas ${createdCompanies.length} empresas em ${performanceTime}ms`);
    
    // 8. Teste de √çndices
    logger.info('üìä Testando √≠ndices...');
    
    const indexStart = Date.now();
    const companyByEmail = await Company.findOne({ email: 'teste@mongotest.com' });
    const indexTime = Date.now() - indexStart;
    
    if (companyByEmail && indexTime < 100) {
      logger.info(`‚úÖ Busca por √≠ndice eficiente: ${indexTime}ms`);
    }
    
    // 9. Teste de Valida√ß√µes
    logger.info('‚úÖ Testando valida√ß√µes...');
    
    try {
      const invalidCompany = new Company({
        name: 'T', // Muito curto
        cnpj: '123', // Inv√°lido
        email: 'email-inv√°lido',
        phone: '123',
      });
      await invalidCompany.save();
      throw new Error('Valida√ß√£o deveria ter falhado');
    } catch (validationError) {
      logger.info('‚úÖ Valida√ß√µes funcionando corretamente');
    }
    
    // 10. Limpeza
    logger.info('üßπ Limpando dados de teste...');
    await Company.deleteMany({ name: { $regex: /Teste|Performance/ } });
    await User.deleteMany({ email: { $regex: /@mongotest\.com/ } });
    
    // 11. Estat√≠sticas Finais
    const totalTime = Date.now() - startTime;
    const stats = {
      totalTime: `${totalTime}ms`,
      connection: Database.isDbConnected() ? 'ativa' : 'inativa',
      collections: ['companies', 'users'],
      indexes: 'funcionando',
      performance: performanceTime < 1000 ? 'boa' : 'lenta',
    };
    
    logger.info('üìä Estat√≠sticas finais:', stats);
    logger.info('üéâ Todos os testes passaram com sucesso!');
    
    return Promise.resolve();
    
  } catch (error) {
    logger.error('‚ùå Teste falhou:', error);
    throw error;
  } finally {
    await Database.disconnect();
  }
}

// Executar testes se chamado diretamente
if (import.meta.url === `file://${process.argv[1]}`) {
  testMongoDB()
    .then(() => {
      console.log('üéâ Testes MongoDB conclu√≠dos com sucesso!');
      process.exit(0);
    })
    .catch((error) => {
      console.error('üí• Testes falharam:', error);
      process.exit(1);
    });
}

export default testMongoDB;