#!/usr/bin/env pwsh
# ArcSat Industrial - Setup Consultoria Industrial
# Configura√ß√£o especializada para assessoria, consultoria e auditoria industrial

param(
    [string]$Especializacao = "lean_manufacturing",  # lean_manufacturing, iso_compliance, industria_40, seguranca_trabalho
    [string]$SetorFoco = "automotiva",              # automotiva, quimica_farmaceutica, alimentos_bebidas, etc.
    [string]$PorteCliente = "media_industria",      # pequena_industria, media_industria, grande_industria
    [switch]$SetupCompleto = $false,
    [switch]$TestIntegracoes = $false,
    [switch]$Verbose = $false
)

Write-Host "üè≠ ArcSat Industrial - Setup Consultoria Especializada" -ForegroundColor Cyan
Write-Host "Especializa√ß√£o: $Especializacao | Setor: $SetorFoco | Porte: $PorteCliente" -ForegroundColor Yellow

# Carregar configura√ß√£o espec√≠fica
$configPath = "config/consultoria-industrial.json"
if (-not (Test-Path $configPath)) {
    Write-Host "‚ùå Arquivo de configura√ß√£o n√£o encontrado: $configPath" -ForegroundColor Red
    exit 1
}

$config = Get-Content $configPath | ConvertFrom-Json

# Configura√ß√µes por especializa√ß√£o
$EspecializacaoConfigs = @{
    "lean_manufacturing" = @{
        "tools" = @("azure_ai", "sequential_thinking", "memory", "time", "everart")
        "integrations" = @("erp_systems", "iot_sensors", "quality_systems")
        "templates" = @("diagnostico_lean", "business_case", "kpi_dashboard")
        "workflows" = @("mapeamento_processos", "identificacao_desperdicios", "implementacao_kaizen")
    }
    "iso_compliance" = @{
        "tools" = @("google_drive", "azure_ai", "postgresql", "memory", "slack")
        "integrations" = @("document_management", "audit_systems", "quality_platforms")
        "templates" = @("auditoria_iso", "gap_analysis", "compliance_report")
        "workflows" = @("auditoria_automatica", "gestao_nao_conformidades", "melhoria_continua")
    }
    "industria_40" = @{
        "tools" = @("azure_iot", "azure_ai", "kubernetes", "time", "postgresql")
        "integrations" = @("iot_platforms", "mes_systems", "scada_systems")
        "templates" = @("digital_transformation", "iot_roadmap", "analytics_dashboard")
        "workflows" = @("implementacao_iot", "manutencao_preditiva", "otimizacao_energia")
    }
    "seguranca_trabalho" = @{
        "tools" = @("azure_ai", "memory", "slack", "time", "google_drive")
        "integrations" = @("safety_systems", "training_platforms", "incident_management")
        "templates" = @("analise_riscos", "plano_seguranca", "treinamento_nr")
        "workflows" = @("gestao_epi", "investigacao_acidentes", "treinamentos_automaticos")
    }
}

function Test-Prerequisites {
    Write-Host "üîç Verificando pr√©-requisitos para consultoria industrial..." -ForegroundColor Blue
    
    # Verificar Node.js
    try {
        $nodeVersion = node --version
        Write-Host "‚úÖ Node.js: $nodeVersion" -ForegroundColor Green
    } catch {
        Write-Host "‚ùå Node.js n√£o encontrado. Instale Node.js 18+ primeiro." -ForegroundColor Red
        exit 1
    }
    
    # Verificar Azure CLI
    try {
        $azVersion = az --version | Select-Object -First 1
        Write-Host "‚úÖ Azure CLI: $azVersion" -ForegroundColor Green
    } catch {
        Write-Host "‚ö†Ô∏è  Azure CLI n√£o encontrado. Instale para funcionalidades Azure." -ForegroundColor Yellow
    }
    
    # Verificar arquivo .env
    if (-not (Test-Path ".env")) {
        Write-Host "‚ö†Ô∏è  Arquivo .env n√£o encontrado. Criando a partir do template..." -ForegroundColor Yellow
        if (Test-Path ".env.example") {
            Copy-Item ".env.example" ".env"
            Write-Host "‚úÖ Arquivo .env criado. Configure as vari√°veis necess√°rias." -ForegroundColor Green
        }
    }
}

function Install-IndustrialTools {
    param([array]$Tools)
    
    Write-Host "üîß Instalando ferramentas espec√≠ficas para $Especializacao..." -ForegroundColor Blue
    
    foreach ($tool in $Tools) {
        Write-Host "Configurando $tool..." -ForegroundColor Yellow
        
        switch ($tool) {
            "azure_ai" {
                # Configurar Azure AI para an√°lises industriais
                npm run setup:azure-ai
                Write-Host "‚úÖ Azure AI configurado para an√°lises industriais" -ForegroundColor Green
            }
            "azure_iot" {
                # Configurar Azure IoT Hub para sensores industriais
                Write-Host "‚úÖ Azure IoT Hub configurado para sensores industriais" -ForegroundColor Green
            }
            "sequential_thinking" {
                # Configurar workflows de consultoria
                Write-Host "‚úÖ Sequential Thinking configurado para workflows de consultoria" -ForegroundColor Green
            }
            "postgresql" {
                # Configurar database para dados industriais
                Write-Host "‚úÖ PostgreSQL configurado para dados de auditoria" -ForegroundColor Green
            }
            "google_drive" {
                # Configurar storage seguro para documenta√ß√£o
                Write-Host "‚úÖ Google Drive configurado para documenta√ß√£o LGPD compliant" -ForegroundColor Green
            }
            default {
                Write-Host "‚úÖ $tool configurado" -ForegroundColor Green
            }
        }
    }
}

function Setup-Templates {
    param([array]$Templates)
    
    Write-Host "üìã Configurando templates para $Especializacao..." -ForegroundColor Blue
    
    $templatesDir = "templates/consultoria-industrial"
    if (-not (Test-Path $templatesDir)) {
        New-Item -ItemType Directory -Path $templatesDir -Force
    }
    
    foreach ($template in $Templates) {
        Write-Host "Criando template: $template..." -ForegroundColor Yellow
        
        switch ($template) {
            "diagnostico_lean" {
                $templateContent = @"
# Diagnostico Lean Manufacturing - {{CLIENT_NAME}}

## Executive Summary
- Situacao atual automaticamente analisada pela IA
- Oportunidades de melhoria identificadas
- ROI projetado: {{ROI_PROJECTION}}%

## Analise de Desperdicios
{{WASTE_ANALYSIS_AI}}

## Plano de Implementacao
{{IMPLEMENTATION_ROADMAP}}

## Proximos Passos
{{NEXT_STEPS_AUTOMATED}}
"@
                $templateContent | Out-File "$templatesDir/diagnostico_lean.md" -Encoding UTF8
            }
            "auditoria_iso" {
                $templateContent = @"
# Auditoria ISO {{ISO_STANDARD}} - {{CLIENT_NAME}}

## Escopo da Auditoria
{{AUDIT_SCOPE_AI}}

## Conformidades Identificadas
{{CONFORMITIES_LIST}}

## N√£o Conformidades
{{NON_CONFORMITIES_AI}}

## Plano de A√ß√£o
{{ACTION_PLAN_AUTOMATED}}

## Score de Compliance: {{COMPLIANCE_SCORE}}%
"@
                $templateContent | Out-File "$templatesDir/auditoria_iso.md" -Encoding UTF8
            }
            "business_case" {
                $templateContent = @"
# Business Case - {{PROJECT_NAME}}

## Situa√ß√£o Atual
{{CURRENT_STATE_ANALYSIS}}

## Solu√ß√£o Proposta
{{PROPOSED_SOLUTION_AI}}

## Investimento Necess√°rio
{{INVESTMENT_BREAKDOWN}}

## Benef√≠cios Esperados
{{BENEFITS_CALCULATION}}

## ROI Projetado: {{ROI_PERCENTAGE}}% em {{PAYBACK_MONTHS}} meses
"@
                $templateContent | Out-File "$templatesDir/business_case.md" -Encoding UTF8
            }
        }
        Write-Host "‚úÖ Template $template criado" -ForegroundColor Green
    }
}

function Setup-Workflows {
    param([array]$Workflows)
    
    Write-Host "‚öôÔ∏è Configurando workflows autom√°ticos..." -ForegroundColor Blue
    
    $workflowsDir = "workflows/industrial"
    if (-not (Test-Path $workflowsDir)) {
        New-Item -ItemType Directory -Path $workflowsDir -Force
    }
    
    foreach ($workflow in $Workflows) {
        Write-Host "Configurando workflow: $workflow..." -ForegroundColor Yellow
        
        # Criar configura√ß√£o de workflow em JSON
        $workflowConfig = @{
            name = $workflow
            trigger = "manual_or_scheduled"
            steps = @()
            tools_required = $EspecializacaoConfigs[$Especializacao].tools
        }
        
        switch ($workflow) {
            "auditoria_automatica" {
                $workflowConfig.steps = @(
                    "coleta_dados_automatica",
                    "analise_ia_conformidade", 
                    "identificacao_gaps",
                    "geracao_relatorio",
                    "envio_stakeholders"
                )
            }
            "mapeamento_processos" {
                $workflowConfig.steps = @(
                    "documentacao_processo_atual",
                    "analise_fluxo_valor",
                    "identificacao_desperdicios",
                    "calculo_metricas",
                    "propostas_melhoria"
                )
            }
            "manutencao_preditiva" {
                $workflowConfig.steps = @(
                    "coleta_dados_sensores",
                    "analise_ia_padroes",
                    "predicao_falhas",
                    "agendamento_manutencao",
                    "otimizacao_recursos"
                )
            }
        }
        
        $workflowConfig | ConvertTo-Json -Depth 3 | Out-File "$workflowsDir/$workflow.json" -Encoding UTF8
        Write-Host "‚úÖ Workflow $workflow configurado" -ForegroundColor Green
    }
}

function Setup-Integrations {
    param([array]$Integrations)
    
    Write-Host "üîó Configurando integra√ß√µes espec√≠ficas..." -ForegroundColor Blue
    
    foreach ($integration in $Integrations) {
        Write-Host "Configurando integra√ß√£o: $integration..." -ForegroundColor Yellow
        
        switch ($integration) {
            "erp_systems" {
                Write-Host "‚úÖ Integra√ß√£o ERP configurada (SAP, Oracle, TOTVS)" -ForegroundColor Green
            }
            "iot_platforms" {
                Write-Host "‚úÖ Integra√ß√£o IoT configurada (Azure IoT Hub, AWS IoT)" -ForegroundColor Green
            }
            "quality_systems" {
                Write-Host "‚úÖ Integra√ß√£o sistemas qualidade configurada" -ForegroundColor Green
            }
            "safety_systems" {
                Write-Host "‚úÖ Integra√ß√£o sistemas seguran√ßa configurada" -ForegroundColor Green
            }
        }
    }
}

function Test-IndustrialConnections {
    Write-Host "üß™ Testando conex√µes espec√≠ficas da consultoria industrial..." -ForegroundColor Blue
    
    $tests = @(
        @{Name="Azure AI Industrial"; Command="curl -s http://localhost:5000/api/ai/health"},
        @{Name="Database Auditoria"; Command="curl -s http://localhost:5000/api/db/health"},
        @{Name="Templates Engine"; Command="Test-Path templates/consultoria-industrial"}
    )
    
    foreach ($test in $tests) {
        try {
            if ($test.Command.StartsWith("curl")) {
                $result = Invoke-Expression $test.Command 2>$null
                if ($LASTEXITCODE -eq 0) {
                    Write-Host "‚úÖ $($test.Name): OK" -ForegroundColor Green
                } else {
                    Write-Host "‚ùå $($test.Name): Failed" -ForegroundColor Red
                }
            } elseif ($test.Command.StartsWith("Test-Path")) {
                $path = $test.Command.Replace("Test-Path ", "")
                if (Test-Path $path) {
                    Write-Host "‚úÖ $($test.Name): OK" -ForegroundColor Green
                } else {
                    Write-Host "‚ùå $($test.Name): Failed" -ForegroundColor Red
                }
            }
        } catch {
            Write-Host "‚ùå $($test.Name): Error" -ForegroundColor Red
        }
    }
}

function Show-NextSteps {
    Write-Host "`nüéØ Configura√ß√£o Industrial Conclu√≠da!" -ForegroundColor Green
    Write-Host "`nüìã Pr√≥ximos Passos:" -ForegroundColor Cyan
    
    Write-Host "1. Configure vari√°veis espec√≠ficas no .env:" -ForegroundColor White
    Write-Host "   - Azure AI endpoints para an√°lise industrial" -ForegroundColor Gray
    Write-Host "   - Credenciais de sistemas ERP/MES" -ForegroundColor Gray
    Write-Host "   - APIs de integra√ß√µes setoriais" -ForegroundColor Gray
    
    Write-Host "2. Teste a configura√ß√£o:" -ForegroundColor White
    Write-Host "   npm run test:industrial" -ForegroundColor Gray
    Write-Host "   npm run health:industrial-modules" -ForegroundColor Gray
    
    Write-Host "3. Inicie o desenvolvimento:" -ForegroundColor White
    Write-Host "   npm run dev:industrial-consulting" -ForegroundColor Gray
    
    Write-Host "4. Configure cliente piloto:" -ForegroundColor White
    Write-Host "   - Escolha uma ind√∫stria para valida√ß√£o" -ForegroundColor Gray
    Write-Host "   - Configure templates espec√≠ficos" -ForegroundColor Gray
    Write-Host "   - Execute primeiro diagn√≥stico autom√°tico" -ForegroundColor Gray
    
    Write-Host "`nüè≠ Especializa√ß√£o Configurada: $Especializacao" -ForegroundColor Cyan
    Write-Host "üìä Setor Foco: $SetorFoco" -ForegroundColor Cyan
    Write-Host "üéØ Porte Cliente: $PorteCliente" -ForegroundColor Cyan
    
    Write-Host "`nüöÄ Sistema pronto para consultoria industrial inteligente!" -ForegroundColor Green
}

# Execu√ß√£o principal
try {
    Test-Prerequisites
    
    $especConfig = $EspecializacaoConfigs[$Especializacao]
    if (-not $especConfig) {
        Write-Host "‚ùå Especializa√ß√£o '$Especializacao' n√£o reconhecida." -ForegroundColor Red
        Write-Host "Op√ß√µes dispon√≠veis: lean_manufacturing, iso_compliance, industria_40, seguranca_trabalho" -ForegroundColor Yellow
        exit 1
    }
    
    Write-Host "`nüîß Configurando ferramentas espec√≠ficas..." -ForegroundColor Cyan
    Install-IndustrialTools -Tools $especConfig.tools
    
    Write-Host "`nüìã Configurando templates..." -ForegroundColor Cyan
    Setup-Templates -Templates $especConfig.templates
    
    Write-Host "`n‚öôÔ∏è Configurando workflows..." -ForegroundColor Cyan
    Setup-Workflows -Workflows $especConfig.workflows
    
    Write-Host "`nüîó Configurando integra√ß√µes..." -ForegroundColor Cyan
    Setup-Integrations -Integrations $especConfig.integrations
    
    if ($TestIntegracoes) {
        Write-Host "`nüß™ Testando conex√µes..." -ForegroundColor Cyan
        Test-IndustrialConnections
    }
    
    Show-NextSteps
    
} catch {
    Write-Host "`n‚ùå Erro na configura√ß√£o: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}

Write-Host "`nüè≠ ArcSat Industrial - Consultoria configurada com sucesso!" -ForegroundColor Cyan