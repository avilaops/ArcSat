# Troubleshooting Azure Deployment - ArcSat

Este guia ajuda a resolver problemas comuns durante o deploy no Azure.

## üîç Diagn√≥stico Inicial

### 1. Verificar Status dos Servi√ßos

```bash
# Status do App Service
az webapp show --name arcsat-api --resource-group ArcSat-RG --query "state"

# Status do Static Web App
az staticwebapp show --name arcsat-frontend --resource-group ArcSat-RG --query "status"

# Verificar health check
curl https://arcsat-api.azurewebsites.net/health
```

### 2. Verificar Logs

```bash
# Logs em tempo real
az webapp log tail --name arcsat-api --resource-group ArcSat-RG

# Download de logs
az webapp log download --name arcsat-api --resource-group ArcSat-RG --log-file logs.zip

# Logs do Application Insights
az monitor app-insights query \
  --app arcsat-insights \
  --analytics-query "traces | where timestamp > ago(1h) | order by timestamp desc"
```

## üêõ Problemas Comuns

### Aplica√ß√£o n√£o inicia

**Sintomas:**
- Status HTTP 503
- Timeout ao acessar a aplica√ß√£o
- Logs mostram "Application Error"

**Solu√ß√µes:**

1. **Verificar vari√°veis de ambiente:**
```bash
az webapp config appsettings list --name arcsat-api --resource-group ArcSat-RG
```

2. **Verificar vers√£o do Node.js:**
```bash
az webapp config show --name arcsat-api --resource-group ArcSat-RG \
  --query "linuxFxVersion"
```

3. **Verificar health check:**
```bash
az webapp config show --name arcsat-api --resource-group ArcSat-RG \
  --query "healthCheckPath"
```

4. **Reiniciar o servi√ßo:**
```bash
az webapp restart --name arcsat-api --resource-group ArcSat-RG
```

### Erro de Conex√£o com MongoDB

**Sintomas:**
- Erro: "MongoServerError: connection refused"
- Timeout ao conectar com o banco

**Solu√ß√µes:**

1. **Verificar IP na whitelist do MongoDB Atlas:**
   - Acesse MongoDB Atlas Dashboard
   - Network Access ‚Üí Add Azure IPs
   - Ou adicione "0.0.0.0/0" para permitir todos (n√£o recomendado para produ√ß√£o)

2. **Verificar connection string:**
```bash
# Ver secret no Key Vault
az keyvault secret show --vault-name arcsat-kv --name mongodb-uri
```

3. **Testar conex√£o manualmente:**
```bash
# SSH no container
az webapp ssh --name arcsat-api --resource-group ArcSat-RG

# Testar conex√£o
node -e "require('mongoose').connect(process.env.MONGO_URI).then(() => console.log('Connected')).catch(e => console.error(e))"
```

### Application Insights n√£o mostra dados

**Sintomas:**
- Dashboard vazio
- Nenhuma telemetria vis√≠vel

**Solu√ß√µes:**

1. **Verificar connection string:**
```bash
az webapp config appsettings list --name arcsat-api --resource-group ArcSat-RG \
  | grep APPLICATIONINSIGHTS_CONNECTION_STRING
```

2. **Verificar se o pacote est√° instalado:**
```bash
npm list applicationinsights
```

3. **Aguardar propaga√ß√£o:**
   - Telemetria pode levar at√© 5 minutos para aparecer
   - Fazer algumas requisi√ß√µes √† API para gerar dados

4. **Verificar logs de inicializa√ß√£o:**
```bash
az webapp log tail --name arcsat-api --resource-group ArcSat-RG | grep "Application Insights"
```

### Erro 404 em rotas do Next.js

**Sintomas:**
- P√°ginas funcionam localmente mas n√£o no Azure
- Erro 404 ao acessar rotas

**Solu√ß√µes:**

1. **Verificar output do build:**
```bash
cd frontend/arcsat-landing
npm run build
# Verificar se .next foi criado corretamente
```

2. **Verificar staticwebapp.config.json:**
   - Confirmar que navigationFallback est√° configurado
   - Verificar rotas exclu√≠das

3. **Redeployar:**
```bash
az staticwebapp deployment list --name arcsat-frontend --resource-group ArcSat-RG
```

### Build falha no GitHub Actions

**Sintomas:**
- GitHub Actions workflow falha
- Erro durante npm install ou npm build

**Solu√ß√µes:**

1. **Verificar secrets:**
   - `AZURE_WEBAPP_PUBLISH_PROFILE_API`
   - `AZURE_STATIC_WEB_APPS_API_TOKEN`

2. **Verificar depend√™ncias:**
```bash
# Local
npm ci
npm run build
```

3. **Verificar package.json:**
   - Scripts devem existir: start, build
   - Node version compat√≠vel com Azure

4. **Limpar cache:**
```bash
# No workflow, adicionar:
- name: Clear npm cache
  run: npm cache clean --force
```

### Problemas com CORS

**Sintomas:**
- Erro CORS no console do navegador
- Requisi√ß√µes bloqueadas

**Solu√ß√µes:**

1. **Configurar CORS no backend:**
```javascript
// Verificar src/server.js
app.use(cors({
  origin: process.env.CORS_ORIGINS ? JSON.parse(process.env.CORS_ORIGINS) : '*',
  credentials: true
}));
```

2. **Adicionar origens permitidas:**
```bash
az webapp config appsettings set \
  --name arcsat-api \
  --resource-group ArcSat-RG \
  --settings CORS_ORIGINS='["https://arcsat.com.br","https://app.arcsat.com.br"]'
```

### Erro de Mem√≥ria (Out of Memory)

**Sintomas:**
- Aplica√ß√£o reinicia frequentemente
- Erro: "JavaScript heap out of memory"

**Solu√ß√µes:**

1. **Aumentar mem√≥ria do Node.js:**
```bash
az webapp config appsettings set \
  --name arcsat-api \
  --resource-group ArcSat-RG \
  --settings NODE_OPTIONS="--max-old-space-size=2048"
```

2. **Escalar plano:**
```bash
az appservice plan update \
  --name ArcSat-Plan \
  --resource-group ArcSat-RG \
  --sku B2
```

### Lentid√£o na Aplica√ß√£o

**Sintomas:**
- Requisi√ß√µes lentas
- Timeout frequente

**Solu√ß√µes:**

1. **Habilitar Always On:**
```bash
az webapp config set \
  --name arcsat-api \
  --resource-group ArcSat-RG \
  --always-on true
```

2. **Verificar m√©tricas no Application Insights:**
```kusto
requests
| where timestamp > ago(1h)
| summarize avg(duration), percentile(duration, 95) by name
| order by avg_duration desc
```

3. **Otimizar consultas ao banco:**
   - Adicionar √≠ndices no MongoDB
   - Implementar cache

## üìä Monitoramento e Diagn√≥stico

### Queries √∫teis no Application Insights

```kusto
// Requisi√ß√µes mais lentas
requests
| where timestamp > ago(24h)
| order by duration desc
| take 10

// Erros por endpoint
exceptions
| where timestamp > ago(24h)
| summarize count() by operation_Name
| order by count_ desc

// Taxa de erro
requests
| where timestamp > ago(1h)
| summarize total=count(), errors=countif(success == false)
| extend errorRate = todouble(errors) / todouble(total) * 100

// Depend√™ncias (MongoDB, APIs externas)
dependencies
| where timestamp > ago(24h)
| summarize avg(duration), count() by name, type
| order by avg_duration desc
```

### Alertas Recomendados

```bash
# CPU acima de 80%
az monitor metrics alert create \
  --name "High-CPU-Alert" \
  --resource-group ArcSat-RG \
  --scopes /subscriptions/{subscription-id}/resourceGroups/ArcSat-RG/providers/Microsoft.Web/sites/arcsat-api \
  --condition "avg Percentage CPU > 80" \
  --window-size 5m

# Mem√≥ria acima de 80%
az monitor metrics alert create \
  --name "High-Memory-Alert" \
  --resource-group ArcSat-RG \
  --scopes /subscriptions/{subscription-id}/resourceGroups/ArcSat-RG/providers/Microsoft.Web/sites/arcsat-api \
  --condition "avg MemoryPercentage > 80" \
  --window-size 5m

# Tempo de resposta alto
az monitor metrics alert create \
  --name "Slow-Response-Alert" \
  --resource-group ArcSat-RG \
  --scopes /subscriptions/{subscription-id}/resourceGroups/ArcSat-RG/providers/Microsoft.Web/sites/arcsat-api \
  --condition "avg ResponseTime > 5" \
  --window-size 5m
```

## üîß Ferramentas de Diagn√≥stico

### Kudu (Advanced Tools)

Acesse: `https://arcsat-api.scm.azurewebsites.net`

Funcionalidades:
- Console SSH
- Explorador de arquivos
- Logs em tempo real
- Informa√ß√µes do ambiente

### Azure CLI Troubleshooting

```bash
# Verificar estado detalhado
az webapp show --name arcsat-api --resource-group ArcSat-RG

# Verificar configura√ß√µes
az webapp config show --name arcsat-api --resource-group ArcSat-RG

# Verificar slots de deployment
az webapp deployment slot list --name arcsat-api --resource-group ArcSat-RG

# Verificar hist√≥rico de deployment
az webapp deployment list-publishing-profiles \
  --name arcsat-api \
  --resource-group ArcSat-RG
```

## üìû Suporte

Se o problema persistir ap√≥s tentar estas solu√ß√µes:

1. **Coletar informa√ß√µes:**
   - Logs completos
   - Mensagens de erro
   - Hor√°rio do incidente
   - Configura√ß√µes atuais

2. **Contatar suporte:**
   - Email: nicolas@avila.inc
   - Azure Support Portal: https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade

3. **Recursos adicionais:**
   - [Azure App Service Docs](https://docs.microsoft.com/azure/app-service/)
   - [Application Insights Docs](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview)
   - [F√≥rum Azure](https://social.msdn.microsoft.com/Forums/azure/)
