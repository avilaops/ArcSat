# Guia de Deploy no Azure - ArcSat

Este guia detalha como fazer o deploy do ArcSat na plataforma Azure.

## üìã Pr√©-requisitos

1. **Conta Azure** - Tenha uma conta ativa no Azure
2. **Azure CLI** - Instale a Azure CLI: https://docs.microsoft.com/cli/azure/install-azure-cli
3. **Node.js 18+** - Para desenvolvimento local
4. **Git** - Para controle de vers√£o

## üèóÔ∏è Arquitetura no Azure

### Backend (API)
- **Servi√ßo**: Azure App Service (Linux)
- **Runtime**: Node.js 18
- **Banco de Dados**: MongoDB Atlas ou Azure Cosmos DB
- **Monitoramento**: Application Insights

### Frontend
- **Servi√ßo**: Azure Static Web Apps
- **Framework**: Next.js 16
- **CDN**: Integrado com Azure CDN

## üöÄ Deploy do Backend (API)

### 1. Criar Resource Group

```bash
az group create --name ArcSat-RG --location brazilsouth
```

### 2. Criar Azure App Service Plan

```bash
az appservice plan create \
  --name ArcSat-Plan \
  --resource-group ArcSat-RG \
  --is-linux \
  --sku B1
```

### 3. Criar Web App

```bash
az webapp create \
  --name arcsat-api \
  --resource-group ArcSat-RG \
  --plan ArcSat-Plan \
  --runtime "NODE|18-lts"
```

### 4. Configurar Vari√°veis de Ambiente

```bash
# Configura√ß√µes b√°sicas
az webapp config appsettings set \
  --name arcsat-api \
  --resource-group ArcSat-RG \
  --settings \
    NODE_ENV=production \
    PORT=8080 \
    WEBSITE_NODE_DEFAULT_VERSION=18.x

# Configura√ß√µes de seguran√ßa (use Azure Key Vault em produ√ß√£o)
az webapp config appsettings set \
  --name arcsat-api \
  --resource-group ArcSat-RG \
  --settings \
    MONGO_URI="@Microsoft.KeyVault(SecretUri=https://your-keyvault.vault.azure.net/secrets/mongodb-uri)" \
    JWT_SECRET="@Microsoft.KeyVault(SecretUri=https://your-keyvault.vault.azure.net/secrets/jwt-secret)"
```

### 5. Criar Application Insights

```bash
az monitor app-insights component create \
  --app arcsat-insights \
  --location brazilsouth \
  --resource-group ArcSat-RG

# Obter connection string
az monitor app-insights component show \
  --app arcsat-insights \
  --resource-group ArcSat-RG \
  --query connectionString
```

### 6. Configurar Application Insights no App Service

```bash
az webapp config appsettings set \
  --name arcsat-api \
  --resource-group ArcSat-RG \
  --settings \
    APPLICATIONINSIGHTS_CONNECTION_STRING="<connection-string-from-previous-step>"
```

### 7. Configurar Health Check

```bash
az webapp config set \
  --name arcsat-api \
  --resource-group ArcSat-RG \
  --health-check-path "/health"
```

### 8. Deploy via GitHub Actions

Configure os seguintes secrets no GitHub:

- `AZURE_WEBAPP_PUBLISH_PROFILE_API`: Obtenha com:
  ```bash
  az webapp deployment list-publishing-profiles \
    --name arcsat-api \
    --resource-group ArcSat-RG \
    --xml
  ```

### 9. Deploy Manual

```bash
# Fazer build local
npm ci --production

# Deploy via ZIP
az webapp deployment source config-zip \
  --name arcsat-api \
  --resource-group ArcSat-RG \
  --src arcsat-api.zip
```

## üé® Deploy do Frontend

### 1. Criar Azure Static Web App

```bash
az staticwebapp create \
  --name arcsat-frontend \
  --resource-group ArcSat-RG \
  --source https://github.com/avilaops/ArcSat \
  --location brazilsouth \
  --branch main \
  --app-location "/frontend/arcsat-landing" \
  --output-location ".next" \
  --login-with-github
```

### 2. Obter Deployment Token

```bash
az staticwebapp secrets list \
  --name arcsat-frontend \
  --resource-group ArcSat-RG \
  --query "properties.apiKey"
```

### 3. Configurar no GitHub

Adicione o token como secret `AZURE_STATIC_WEB_APPS_API_TOKEN`

### 4. Deploy Manual

```bash
cd frontend/arcsat-landing
npm ci
npm run build

# Usar Static Web Apps CLI
npm install -g @azure/static-web-apps-cli
swa deploy .next --deployment-token <seu-token>
```

## üîê Seguran√ßa com Azure Key Vault

### 1. Criar Key Vault

```bash
az keyvault create \
  --name arcsat-kv \
  --resource-group ArcSat-RG \
  --location brazilsouth
```

### 2. Adicionar Secrets

```bash
# MongoDB URI
az keyvault secret set \
  --vault-name arcsat-kv \
  --name mongodb-uri \
  --value "mongodb+srv://..."

# JWT Secret
az keyvault secret set \
  --vault-name arcsat-kv \
  --name jwt-secret \
  --value "seu-jwt-secret-aqui"
```

### 3. Dar Permiss√£o ao App Service

```bash
# Habilitar Managed Identity
az webapp identity assign \
  --name arcsat-api \
  --resource-group ArcSat-RG

# Dar permiss√£o de leitura ao Key Vault
az keyvault set-policy \
  --name arcsat-kv \
  --object-id <managed-identity-principal-id> \
  --secret-permissions get list
```

## üìä Monitoramento

### Application Insights - Queries √öteis

```kusto
// Requisi√ß√µes por endpoint
requests
| where timestamp > ago(24h)
| summarize count() by name, resultCode
| order by count_ desc

// Erros recentes
exceptions
| where timestamp > ago(1h)
| order by timestamp desc

// Performance por endpoint
requests
| where timestamp > ago(24h)
| summarize avg(duration), percentile(duration, 95) by name
```

### Configurar Alertas

```bash
# Alerta para erros HTTP 5xx
az monitor metrics alert create \
  --name "API-5xx-Errors" \
  --resource-group ArcSat-RG \
  --scopes /subscriptions/{subscription-id}/resourceGroups/ArcSat-RG/providers/Microsoft.Web/sites/arcsat-api \
  --condition "count Http5xx > 10" \
  --window-size 5m \
  --evaluation-frequency 1m
```

## üîÑ CI/CD com GitHub Actions

O workflow em `.github/workflows/main.yml` est√° configurado para deploy autom√°tico.

**Secrets necess√°rios:**
- `AZURE_WEBAPP_PUBLISH_PROFILE_API`
- `AZURE_STATIC_WEB_APPS_API_TOKEN`

## üåê Dom√≠nios Personalizados

### Backend (App Service)

```bash
# Adicionar dom√≠nio customizado
az webapp config hostname add \
  --webapp-name arcsat-api \
  --resource-group ArcSat-RG \
  --hostname api.arcsat.com.br

# Habilitar HTTPS
az webapp config ssl bind \
  --name arcsat-api \
  --resource-group ArcSat-RG \
  --certificate-thumbprint <cert-thumbprint> \
  --ssl-type SNI
```

### Frontend (Static Web App)

```bash
# Adicionar dom√≠nio customizado
az staticwebapp hostname set \
  --name arcsat-frontend \
  --resource-group ArcSat-RG \
  --hostname arcsat.com.br
```

## üß™ Testes e Valida√ß√£o

### Health Check

```bash
# Verificar sa√∫de da API
curl https://arcsat-api.azurewebsites.net/health

# Verificar prontid√£o
curl https://arcsat-api.azurewebsites.net/api/health/ready
```

### Logs

```bash
# Ver logs em tempo real
az webapp log tail \
  --name arcsat-api \
  --resource-group ArcSat-RG

# Download de logs
az webapp log download \
  --name arcsat-api \
  --resource-group ArcSat-RG \
  --log-file logs.zip
```

## üí∞ Estimativa de Custos (Brasil South)

- **App Service (B1)**: ~R$ 50/m√™s
- **Static Web Apps (Free tier)**: R$ 0
- **Application Insights (5GB/m√™s)**: ~R$ 100/m√™s
- **Key Vault**: ~R$ 5/m√™s
- **Total estimado**: ~R$ 155/m√™s

## üÜò Troubleshooting

### API n√£o inicia

```bash
# Verificar logs
az webapp log tail --name arcsat-api --resource-group ArcSat-RG

# Verificar vari√°veis de ambiente
az webapp config appsettings list --name arcsat-api --resource-group ArcSat-RG
```

### Erro de conex√£o com MongoDB

- Verifique se o IP do Azure est√° na whitelist do MongoDB Atlas
- Confirme a connection string no Key Vault

### Application Insights sem dados

- Verifique o connection string
- Confirme que a vari√°vel `APPLICATIONINSIGHTS_CONNECTION_STRING` est√° configurada

## üìö Recursos Adicionais

- [Azure App Service Docs](https://docs.microsoft.com/azure/app-service/)
- [Azure Static Web Apps Docs](https://docs.microsoft.com/azure/static-web-apps/)
- [Application Insights Docs](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview)
- [Azure Key Vault Docs](https://docs.microsoft.com/azure/key-vault/)

## ü§ù Suporte

Para problemas ou d√∫vidas:
- Email: nicolas@avila.inc
- Documenta√ß√£o: https://docs.arcsat.com.br
