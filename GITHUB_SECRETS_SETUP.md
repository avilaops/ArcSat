# üîê Configura√ß√£o de Secrets do GitHub Actions

Este guia mostra como configurar todos os secrets necess√°rios para o deploy autom√°tico do ArcSat CRM no Azure.

## üìã Secrets Necess√°rios

Os seguintes secrets devem ser configurados no GitHub para que os workflows funcionem corretamente:

### Secrets Obrigat√≥rios para Deploy Principal (azure-deploy.yml)

1. **AZURE_CREDENTIALS** - Credenciais do Service Principal do Azure
2. **MONGO_ATLAS_URI** - String de conex√£o do MongoDB Atlas
3. **JWT_SECRET** - Chave secreta para gera√ß√£o de tokens JWT
4. **OPENAI_API_KEY** - Chave da API OpenAI (se utilizado)
5. **CLOUDFLARE_API_TOKEN** - Token da API Cloudflare (para DNS/CDN)

### Secrets Adicionais (main.yml - se utilizado)

6. **AZURE_WEBAPP_PUBLISH_PROFILE_API** - Perfil de publica√ß√£o do Azure Web App
7. **AZURE_STATIC_WEB_APPS_API_TOKEN** - Token para Azure Static Web Apps

---

## üöÄ Como Adicionar Secrets no GitHub

### Passo a Passo:

1. **Acesse as configura√ß√µes do reposit√≥rio:**
   ```
   https://github.com/avilaops/ArcSat/settings/secrets/actions
   ```

2. **Clique em "New repository secret"**

3. **Adicione cada secret individualmente** usando as informa√ß√µes abaixo

---

## üîë Detalhes de Cada Secret

### 1. AZURE_CREDENTIALS

**Descri√ß√£o:** Credenciais do Service Principal do Azure para autentica√ß√£o e deploy.

**Name:** `AZURE_CREDENTIALS`

**Value:** Cole o JSON completo abaixo:

```json
{
  "clientId": "3fdb30d7-1724-49d3-b301-3c0942f5f4b8",
  "clientSecret": "8tW8Q~stoXGO.2JV2FTjrMyunll8tcnmxV2k2an3",
  "subscriptionId": "3b49f371-dd88-46c7-ba30-aeb54bd5c2f6",
  "tenantId": "0e53f641-197a-48b2-83a4-f8222f5d48c0",
  "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",
  "resourceManagerEndpointUrl": "https://management.azure.com/",
  "activeDirectoryGraphResourceId": "https://graph.windows.net/",
  "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",
  "galleryEndpointUrl": "https://gallery.azure.com/",
  "managementEndpointUrl": "https://management.core.windows.net/"
}
```

**Como foi criado:**
```powershell
az ad sp create-for-rbac \
  --name "github-actions-arcsat" \
  --role contributor \
  --scopes /subscriptions/3b49f371-dd88-46c7-ba30-aeb54bd5c2f6/resourceGroups/rg-arcsat-crm \
  --sdk-auth
```

---

### 2. MONGO_ATLAS_URI

**Descri√ß√£o:** String de conex√£o do MongoDB Atlas para o banco de dados.

**Name:** `MONGO_ATLAS_URI`

**Value:**
```
mongodb+srv://nicolasrosaab_db_user:Gio4EAQhbEdQMISl@cluster0.npuhras.mongodb.net/?retryWrites=true&w=majority
```

**Formato:**
```
mongodb+srv://<username>:<password>@<cluster>.mongodb.net/<database>?retryWrites=true&w=majority
```

---

### 3. JWT_SECRET

**Descri√ß√£o:** Chave secreta para assinatura de tokens JWT (autentica√ß√£o).

**Name:** `JWT_SECRET`

**Value:** Use uma string aleat√≥ria segura com no m√≠nimo 32 caracteres.

**Exemplo de gera√ß√£o:**
```bash
# No terminal Linux/Mac
openssl rand -base64 32

# Ou use:
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

**Recomenda√ß√£o:** Gere uma nova chave segura para produ√ß√£o.

---

### 4. OPENAI_API_KEY

**Descri√ß√£o:** Chave da API OpenAI (se o sistema utiliza funcionalidades de IA).

**Name:** `OPENAI_API_KEY`

**Value:**
```
sk-proj-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

**Como obter:**
1. Acesse https://platform.openai.com/api-keys
2. Crie uma nova API key
3. Copie e adicione como secret

**Nota:** Se n√£o estiver usando OpenAI, adicione um valor placeholder ou remova a refer√™ncia do workflow.

---

### 5. CLOUDFLARE_API_TOKEN

**Descri√ß√£o:** Token da API Cloudflare para gerenciar DNS e CDN.

**Name:** `CLOUDFLARE_API_TOKEN`

**Value:**
```
jOe5bnmHn8EbNCJNjg4yVpUcKNPUiqnfE5B6wNoc
```

**Como obter:**
1. Acesse https://dash.cloudflare.com/profile/api-tokens
2. Crie um token com permiss√µes:
   - Zone:DNS:Edit
   - Zone:Zone:Read
3. Copie o token

**Cloudflare Zone ID:**
```
f5d2e8a5a0afb8bbfd81f02f1e93aa0e
```

---

### 6. AZURE_WEBAPP_PUBLISH_PROFILE_API (Opcional)

**Descri√ß√£o:** Perfil de publica√ß√£o do Azure Web App (m√©todo alternativo de deploy).

**Name:** `AZURE_WEBAPP_PUBLISH_PROFILE_API`

**Como obter:**
```powershell
az webapp deployment list-publishing-profiles \
  --name arcsat-api \
  --resource-group rg-arcsat-crm \
  --xml
```

**Nota:** Este √© um m√©todo alternativo ao `AZURE_CREDENTIALS`. Use apenas se necess√°rio.

---

### 7. AZURE_STATIC_WEB_APPS_API_TOKEN (Opcional)

**Descri√ß√£o:** Token para deploy no Azure Static Web Apps.

**Name:** `AZURE_STATIC_WEB_APPS_API_TOKEN`

**Como obter:**
1. No Portal Azure, acesse o recurso Static Web App
2. V√° em "Manage deployment token"
3. Copie o token

**Nota:** Necess√°rio apenas se estiver usando Azure Static Web Apps para o frontend.

---

## ‚úÖ Checklist de Configura√ß√£o

Ap√≥s adicionar os secrets, verifique:

- [ ] **AZURE_CREDENTIALS** adicionado com JSON completo
- [ ] **MONGO_ATLAS_URI** adicionado com connection string v√°lida
- [ ] **JWT_SECRET** gerado e adicionado (m√≠nimo 32 caracteres)
- [ ] **OPENAI_API_KEY** adicionado (se necess√°rio)
- [ ] **CLOUDFLARE_API_TOKEN** adicionado
- [ ] Testado push para `main` para verificar deploy autom√°tico
- [ ] Verificado logs do GitHub Actions
- [ ] Testado aplica√ß√£o no Azure ap√≥s deploy

---

## üîí Seguran√ßa e Boas Pr√°ticas

### ‚ö†Ô∏è IMPORTANTE:

1. **NUNCA** commite secrets no c√≥digo fonte
2. **NUNCA** compartilhe secrets publicamente
3. **SEMPRE** use secrets do GitHub para informa√ß√µes sens√≠veis
4. **ROTACIONE** secrets periodicamente (a cada 90 dias)
5. **USE** Azure Key Vault para produ√ß√£o quando poss√≠vel
6. **REVOGUE** imediatamente qualquer secret exposto

### Rota√ß√£o de Secrets:

Se um secret for comprometido:

1. **Revogue imediatamente** no Azure/servi√ßo de origem
2. **Gere** um novo secret
3. **Atualize** no GitHub Actions
4. **Teste** o deploy para garantir funcionamento

### Azure Service Principal:

Para revogar/recriar:
```powershell
# Listar service principals
az ad sp list --display-name "github-actions-arcsat"

# Deletar (se necess√°rio)
az ad sp delete --id <object-id>

# Criar novo
az ad sp create-for-rbac \
  --name "github-actions-arcsat" \
  --role contributor \
  --scopes /subscriptions/3b49f371-dd88-46c7-ba30-aeb54bd5c2f6/resourceGroups/rg-arcsat-crm \
  --sdk-auth
```

---

## üöÄ Testando o Deploy

Ap√≥s configurar todos os secrets:

1. **Fa√ßa uma altera√ß√£o no c√≥digo:**
   ```bash
   git add .
   git commit -m "test: verificar deploy autom√°tico"
   git push origin main
   ```

2. **Acompanhe o workflow:**
   ```
   https://github.com/avilaops/ArcSat/actions
   ```

3. **Verifique o deploy:**
   - Azure Portal: https://portal.azure.com
   - Aplica√ß√£o: https://arcsat-crm.azurewebsites.net
   - Dom√≠nio customizado: https://crm.avila.inc (ap√≥s configura√ß√£o DNS)

---

## üêõ Troubleshooting

### Erro: "Secret not found"
- Verifique se o nome do secret est√° exatamente como no workflow
- Secrets s√£o case-sensitive: `AZURE_CREDENTIALS` ‚â† `azure_credentials`

### Erro: "Azure login failed"
- Verifique se o JSON do `AZURE_CREDENTIALS` est√° completo
- Confirme se o Service Principal tem as permiss√µes corretas
- Teste o login manualmente:
  ```bash
  az login --service-principal \
    --username 3fdb30d7-1724-49d3-b301-3c0942f5f4b8 \
    --password 8tW8Q~stoXGO.2JV2FTjrMyunll8tcnmxV2k2an3 \
    --tenant 0e53f641-197a-48b2-83a4-f8222f5d48c0
  ```

### Erro: "MongoDB connection failed"
- Verifique se o MongoDB Atlas permite conex√µes do IP do GitHub Actions
- Configure whitelist: `0.0.0.0/0` (para GitHub Actions)
- Teste a connection string localmente

### Erro: "Deployment failed"
- Verifique logs no Azure Portal
- Confirme se o Web App existe e est√° no resource group correto
- Verifique se h√° recursos suficientes no plano de servi√ßo

---

## üìû Suporte

- **Email:** nicolas@avila.inc
- **GitHub Issues:** https://github.com/avilaops/ArcSat/issues
- **Documenta√ß√£o Azure:** https://docs.microsoft.com/azure
- **GitHub Actions Docs:** https://docs.github.com/actions

---

**√öltima atualiza√ß√£o:** 27/10/2025  
**Vers√£o:** 1.0.0
